<!-- Standalone Generated By Octo (octo-ide.com) -->
<script>data={"program":":macro pointer ADDRESS {\n  :byte { ADDRESS >> 8 }\n  :byte { ADDRESS }\n}\n\n:macro unpack-long ADDR {\n  :calc hi { 0xFF & ADDR >> 8 }\n  :calc lo { 0xFF & ADDR }\n  v0 := hi\n  v1 := lo\n}\n\n:alias X vA\n:alias Y vB\n\n:org 0x200\n\n#####################\n# 3D Viper Maze\n# An Octojam 7 entry\n# By Timendus\n# https://github.com/Timendus/3d-viper-maze\n\n: main\n    clear\n    i := level\n    load v0\n    v0 += 1\n    i := level\n    save v0\n    i := hex v0\n    v0 := 30\n    v1 := 10\n    sprite v0 v1 5\n    randomize-map\n: redraw-loop\n  clear\n  render-3d\n  vD := 0 # Mark exit not found\n  vE := 0 # Mark screen clean\n: main-loop\n  check-keys\n  # Is the screen dirty?\n  if vD == 1 then jump main\n  if vE == 1 then jump redraw-loop\n  jump main-loop\n#####################\n# Decompress some data to the decompression buffer\n# Input: start of compressed data unpacked in v0 and v1\n# Output: 30 uncompressed bytes in decompression-buffer\n# Destroys: absolutely everything ðŸ˜‚\n# Size: 326 bytes including buffers\n\n: decompress\n  :alias num-bytes      vC\n  :alias source-counter vD\n  :alias target-counter vE\n  source-counter := 0\n\ttarget-counter := 0\n  i := decompression-source\n  save v1\n\n: decompress-loop\n  i := decompress-loop-smc\n  v2 := 0xA0\n  v0 |= v2\n  save v1\n: decompress-loop-smc\n  0 0\n  # i points to start\n  i += source-counter\n  # i points to current run\n\tload v0\n  vF := 0x7F\n  num-bytes := v0\n\tnum-bytes &= vF\n  vF := 0x80\n  vB := v0\n  vB &= vF\n  if vB == 0 then jump decompress-repeat\n  # Fall through\n\n# Do a plain load of the next `vC` bytes (constant time, thanks to `load vX`)\n\n: decompress-load\n  source-counter += num-bytes\n  source-counter += 1\n    v0 := num-bytes\n    v0 -= 1\n    v0 <<= v0\n    v0 <<= v0\n  jump0 decompress-load-bytes\n\n: decompress-load-bytes\n  load v0  jump decompress-next\n  load v1  jump decompress-next\n  load v2  jump decompress-next\n  load v3  jump decompress-next\n  load v4  jump decompress-next\n  load v5  jump decompress-next\n  load v6  jump decompress-next\n  load v7  jump decompress-next\n  load v8  jump decompress-next\n  load v9  jump decompress-next\n  load vA  jump decompress-next\n\n# Repeat the next byte `vC` times (time scales as `X + vC`)\n\n: decompress-repeat\n  source-counter += 2\n  load v0\n    v1 := v0\n    v0 := 11\n    v0 -= num-bytes\n    v0 <<= v0\n    vF := v1\n  jump0 decompress-repeat-bytes\n\n: decompress-repeat-bytes\n  vA := vF  v9 := vF  v8 := vF\n  v7 := vF  v6 := vF  v5 := vF\n  v4 := vF  v3 := vF  v2 := vF\n  v1 := vF  v0 := vF\n  jump decompress-next\n\n# Save `vC` bytes to the decompression buffer and add `vC` to the total number\n# of decompressed bytes (constant time, thanks to `save vX`)\n\n: decompress-next\n  i := decompression-buffer\n  i += target-counter\n  target-counter += num-bytes\n    vF := v0\n    v0 := num-bytes\n    vC := vF          # We don't need vC / num-bytes anymore\n    v0 -= 1\n    vB := v0          # v0 times six\n    v0 <<= v0\n    v0 += vB\n    v0 <<= v0\n  jump0 decompress-save-bytes\n\n: decompress-save-bytes\n    v0 := vC  save v0  jump decompress-done\n    v0 := vC  save v1  jump decompress-done\n    v0 := vC  save v2  jump decompress-done\n    v0 := vC  save v3  jump decompress-done\n    v0 := vC  save v4  jump decompress-done\n    v0 := vC  save v5  jump decompress-done\n    v0 := vC  save v6  jump decompress-done\n    v0 := vC  save v7  jump decompress-done\n    v0 := vC  save v8  jump decompress-done\n    v0 := vC  save v9  jump decompress-done\n    v0 := vC  save vA  # Fall through\n\n# If we have the desired number of bytes in the buffer, we're done\n# Otherwise, re-unpack source pointer to v0 and v1 and restart\n\n: decompress-done\n  if target-counter == 30 then return\n  i := decompression-source\n  load v1\n  jump decompress-loop\n\n\n: decompression-buffer\n\t0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0\n  0 0 0 0 0 0 0 0 0 0\n\n: decompression-source\n  0 0\n#####################\n# Look at place (v3 - 1, v4) relative to the player\n# Return value at that position in v0\n: look-ahead\n  i := player\n  load v2\n  if v2 == 0 then jump look-ahead-up\n  if v2 == 1 then jump look-ahead-right\n  if v2 == 2 then jump look-ahead-down\n  # Else fall through\n: look-ahead-left\n  v0 -= v4\n  v1 += 1\n  v1 -= v3\n  jump map-get\n: look-ahead-right\n  v0 += v4\n  v1 -= 1\n  v1 += v3\n  jump map-get\n: look-ahead-up\n  v0 -= 1\n  v0 += v3\n  v1 -= v4\n  jump map-get\n: look-ahead-down\n  v0 += 1\n  v0 -= v3\n  v1 += v4\n  # Fall through\n\n#####################\n# Query the map for the value at a given position\n# Input: X in v0, Y in v1 (destructive)\n# Output: map value in v0\n# Destroys: v0 - v3, i\n: map-get\n  i := map\n  i += v0\n  v1 <<= v1\n  v1 <<= v1\n  v1 <<= v1\n  v1 <<= v1\n  i += v1\n  load v0\n  return\n\n#####################\n# Read map at X,Y into v0\n# Destroys i\n: map-read\n  i := map\n  i += X\n  v0 := Y\n  v0 <<= v0\n  v0 <<= v0\n  v0 <<= v0\n  v0 <<= v0\n  i += v0\n  load v0\n  return\n\n#####################\n# Write v0 into map at X,Y\n# Destroys v1, i\n: map-write\n  i := map\n  i += X\n  v1 := Y\n  v1 <<= v1\n  v1 <<= v1\n  v1 <<= v1\n  v1 <<= v1\n  i += v1\n  save v0\n  return\n#####################\n# Render the map to the screen in pseudo-3D\n# (for the actual gameplay)\n\n:const leafoffset 92    # 2 bytes * 46 entries\n:const xcoordoffset 2   # Make -1 coord +1 coords\n\n: render-3d\n  # Column 4\n  vA := 0\n  vB := 0\n  i := nodes-column-four\n  find-sprite\n    decompress\n  v3 := 24\n  render-column\n\n  # Column 5\n  vA := leafoffset\n  vB := xcoordoffset\n  i := nodes-column-four\n  find-sprite\n    decompress\n  v3 := 32\n  render-column\n\n  # Column 3\n  vA := 0\n  vB := 0\n  i := nodes-column-three\n  find-sprite\n    decompress\n  v3 := 16\n  render-column\n\n  # Column 6\n  vA := leafoffset\n  vB := xcoordoffset\n  i := nodes-column-three\n  find-sprite\n    decompress\n  v3 := 40\n  render-column\n\n  # Column 2\n  vA := 0\n  vB := 0\n  i := nodes-column-two\n  find-sprite\n    decompress\n  v3 := 8\n  render-column\n\n  # Column 7\n  vA := leafoffset\n  vB := xcoordoffset\n  i := nodes-column-two\n  find-sprite\n    decompress\n  v3 := 48\n  render-column\n\n  # Column 1\n  vA := 0\n  vB := 0\n  i := nodes-column-one\n  find-sprite\n    decompress\n  v3 := 0\n  render-column\n\n  # Column 8\n  vA := leafoffset\n  vB := xcoordoffset\n  i := nodes-column-one\n  find-sprite\n    decompress\n  v3 := 56\n  # Fall through\n\n: render-column\n    i := decompression-buffer\n  v2 := 15\n  v1 := 1\n  sprite v3 v1 15\n  i += v2\n  v1 := 16\n  sprite v3 v1 15\n  return\n\n#####################\n# This routine walks through the binary tree with nodes and leafs\n# Input:\n#  * i pointing to a node\n#  * vA as an offset to the leaf (0 or leafoffset)\n#  * vB as an offset for the X axis (0 or xcoordoffset)\n# Output: address of image to be rendered unpacked in v0 and v1\n# Destroys: 0v-v6, vF, i\n\n: find-sprite\n  # Load this node and find what's there\n  load v2\n  v5 := v1  # look-ahead destroys these\n  v6 := v2\n  # Coordinates are stored together in first byte, so unpack\n  v3 := v0\n  v4 := v0\n  v1 := 0x0F\n  v4 &= v1\n  v3 >>= v3\n  v3 >>= v3\n  v3 >>= v3\n  v3 >>= v3\n  if v3 == 0 then v3 += vB\n  look-ahead  # v3 and v4 are inputs, v0 is output\n  # Did we encounter a wall?\n  v1 := v5\n  if v0 == 1 then v1 := v6\n  # Is the next step a node or a leaf?\n  v2 := v1\n  v2 <<= v2\n  if vF == 1 then jump find-sprite-done\n  # Next is a node, load it and restart\n  i := nodes\n  i += v1\n  i += v1\n  i += v1\n  jump find-sprite\n: find-sprite-done\n  # Next is a leaf, extract the image pointer\n  # Each pointer is two bytes, bonus: we rotated out leaf indicator bit\n  i := leafs\n  i += v2\n  i += vA\n  load v1\n  # We now have the address of the leaf image in v0 and v1\n  return\n#####################\n# Non-blocking key input check\n# Updates the player data on input, checks for collisions\n# Destroys: v0 - v5, i\n: check-keys\n  i := player\n  load v2\n\n  # Rotation\n  v3 := OCTO_KEY_A\n  if v3 key then jump rotate-left\n  v3 := OCTO_KEY_D\n  if v3 key then jump rotate-right\n\n  # Movement\n  v3 := OCTO_KEY_W\n  v4 := OCTO_KEY_S\n  if v2 == 0 then jump going-up\n  if v2 == 1 then jump going-right\n  if v2 == 2 then jump going-down\n  # Else fall through\n\n: going-left\n  if v3 key then jump move-left\n  if v4 key then jump move-right\n  return\n: going-up\n  if v3 key then jump move-up\n  if v4 key then jump move-down\n  return\n: going-right\n  if v3 key then jump move-right\n  if v4 key then jump move-left\n  return\n: going-down\n  if v3 key then jump move-down\n  if v4 key then jump move-up\n  return\n\n: rotate-left\n  v2 -= 1\n  jump rotate\n: rotate-right\n  v2 += 1\n: rotate\n  v0 := 3\n  v0 &= v2\n  i := player-orientation\n  save v0\n  # Mark screen dirty\n  vE := 1\n  jump wait-key-release\n\n: move-right\n  v2 := 15\n  v0 += 1\n  v0 &= v2\n  jump collide-or-save\n\n: move-left\n  v2 := 15\n  v0 -= 1\n  v0 &= v2\n  jump collide-or-save\n\n: move-up\n  v2 := 7\n  v1 -= 1\n  v1 &= v2\n  jump collide-or-save\n\n: move-down\n  v2 := 7\n  v1 += 1\n  v1 &= v2\n  # Fall through\n\n: collide-or-save\n  # Backup position\n  v4 := v0\n  v5 := v1\n  # Is there a wall at this position?\n  map-get\n  if v0 == 1 then jump wait-key-release\n  if v0 == 7 then vD := 1\n  # Otherwise, update position\n  v0 := v4\n  v1 := v5\n  i := player\n  save v1\n  # Mark screen dirty\n  vE := 1\n  # Fall through\n\n: wait-key-release\n  vA := 0\n: wait-key-release-loop\n  if vA key then jump wait-key-release-loop\n  vA += 1\n  if vA != 16 then jump wait-key-release-loop\n  return\n:alias FRONTIER vC\n:alias RUN vD\n\n: randomize-map\n  # Clear the map (make it all walls)\n  i := map\n  v1 := 0\n  v0 := 1\n: rm-clear-loop\n  save v0\n  v1 += 1\n  if v1 < 128 then jump rm-clear-loop\n\n  # Choose a random starting position\n\tv0 := 7\n\trand\n\tX := v0\n\tX <<= X\n\tX += 1\n\n\tv0 := 3\n\trand\n\tY := v0\n\tY <<= Y\n\tY += 1\n\n  v0 := 4\n  rand\n  v2 := v0\n  v0 := X\n  v1 := Y\n  i := player\n  save v2\n\n  RUN := 0\n  FRONTIER := 0\n\n: rm-mark-spot\n  # Mark spot as new hallway\n  v0 := 0\n  map-write\n\n  # Mark the new frontier\n  if Y > 2 begin # Valid coordinate?\n    Y -= 2\n    map-read\n    if v0 == 1 begin # Empty spot?\n      v0 := 0x12\n      map-write\n      FRONTIER += 1\n    end\n    Y += 2\n  end\n  if X > 2 begin\n    X -= 2\n    map-read\n    if v0 == 1 begin\n      v0 := 0x13\n      map-write\n      FRONTIER += 1\n    end\n    X += 2\n  end\n  if X < 13 begin\n    X += 2\n    map-read\n    if v0 == 1 begin\n      v0 := 0x14\n      map-write\n      FRONTIER += 1\n    end\n    X -= 2\n  end\n  if Y < 6 begin\n    Y += 2\n    map-read\n    if v0 == 1 begin\n      v0 := 0x15\n      map-write\n      FRONTIER += 1\n    end\n    Y -= 2\n  end\n\n  # Are we done yet?\n  if FRONTIER == 0 begin\n    v0 := 7 # Mark the exit\n    map-write\n    return\n  end\n\n  # Show progress\n  RUN += 1\n  v0 := 0\n  i := hex v0\n  v0 := RUN\n  v0 <<= v0\n  v0 += 2\n  v1 := 20\n  sprite v0 v1 5\n\n  # Pick a new frontier to expand\n  v0 := FRONTIER\n  rand\n  v4 := v0\n  X := 1\n  Y := 1\n  v2 := 0x10\n  loop\n    map-read\n    v3 := v0\n    v0 &= v2\n    if v0 != 0 begin\n      if v4 == 0 begin\n        FRONTIER -= 1\n        v0 := 0\n        if v3 == 0x12 begin\n          Y += 1\n          map-write\n          Y -= 1\n        end\n        if v3 == 0x13 begin\n          X += 1\n          map-write\n          X -= 1\n        end\n        if v3 == 0x14 begin\n          X -= 1\n          map-write\n          X += 1\n        end\n        if v3 == 0x15 begin\n          Y -= 1\n          map-write\n          Y += 1\n        end\n        jump rm-mark-spot\n      end\n      v4 -= 1\n    end\n    X += 1\n    if X == 16 begin\n      X := 0\n      Y += 1\n      # if Y == 7 then return # This would be an error state\n    end\n  again\n\n#####################\n# Get a random number\n# Input: v0 is upper bound (exclusive)\n# Output: v0 is random number\n# Destroys: v1, v2, v3\n: rand\n\t# Create bitmask\n\tv2 := 0\n\tv3 := v0\n: rand-mask\n\tv3 >>= v3\n\tv2 <<= v2\n\tv2 += 1\n\tif v3 != 0 then jump rand-mask\n  loop\n  \tv1 := random 255\n  \tv1 &= v2\n  \tif v1 < v0 begin\n      v0 := v1\n  \t  return\n    end\n  again\n\n: hall-0+0+1\n  0x8b 0xf 0xc3 0xe0 0xf4 0x26 0x7 0x83 0xe0 0xf2 0xf3 0x7b 0x8b 0x3 0xc0 0xe6 0xf7 0xe7 0xe6 0xc0 0x3 0x7b 0xf3 0xf0 0x88 0xe0 0xc3 0x7 0x76 0xe0 0xe0 0xc3 0xf\n  \n: hall-0+8+1\n  0x8b 0xff 0xff 0xff 0x3f 0xf 0x43 0x60 0x6a 0xb 0x0 0xa6 0x8b 0x36 0x14 0x40 0x6b 0x69 0x40 0x4 0xa6 0xb4 0x21 0xa 0x88 0x68 0x48 0x43 0xf 0x3f 0xff 0xff 0xff\n  \n: hall-0+16+1\n  0x7 0xff 0x8b 0x3f 0xf 0x63 0x28 0x85 0xb0 0x15 0xc 0x62 0xb 0xa8 0x85 0x81 0x28 0x63 0xf 0x3f 0x7 0xff\n  \n: hall-0+24+1\n  0xb 0xff 0x88 0x3f 0x4f 0x53 0x88 0x50 0x23 0x4f 0x3f 0xb 0xff\n  \n: hall-0+32+1\n  0xb 0xff 0x88 0xfc 0xf2 0xca 0x9 0x12 0xc4 0xf2 0xfc 0xb 0xff\n  \n: hall-0+40+1\n  0x7 0xff 0x8b 0xfc 0xf0 0xc6 0x14 0xa1 0xd 0xa8 0x30 0x46 0xd0 0x15 0x85 0x81 0x14 0xc6 0xf0 0xfc 0x7 0xff\n  \n: hall-0+48+1\n  0x8b 0xff 0xff 0xff 0xfc 0xf0 0xc2 0x6 0x56 0xd0 0x0 0x65 0x8b 0x6c 0x28 0x2 0xd6 0x96 0x2 0x20 0x65 0x2d 0x84 0x50 0x88 0x16 0x12 0xc2 0xf0 0xfc 0xff 0xff 0xff\n  \n: hall-0+56+1\n  0x8b 0xf0 0xc3 0x7 0x2f 0x64 0xe0 0xc1 0x7 0x4f 0xcf 0xde 0x8b 0xc0 0x3 0x67 0xef 0xe7 0x67 0x3 0xc0 0xde 0xcf 0xf 0x88 0x7 0xc3 0xe0 0x6e 0x7 0x7 0xc3 0xf0\n  \n\n: hall-1+0+1\n  0x8b 0xff 0xff 0x0 0x0 0x26 0x6f 0x47 0x0 0x20 0x73 0xf3 0x8b 0x66 0x0 0x26 0x6f 0xef 0x22 0x0 0xe1 0xf7 0x73 0x10 0x88 0x0 0xee 0xe7 0x22 0x0 0x0 0xff 0xff\n  \n  \n: hall-1+56+1\n  0x8b 0xff 0xff 0x0 0x44 0xe6 0xf6 0xe2 0x0 0x4 0xce 0xcf 0x8b 0x66 0x0 0x64 0xf6 0xf7 0x44 0x0 0x87 0xef 0xce 0x8 0x88 0x0 0x77 0xe7 0xe6 0x44 0x0 0xff 0xff\n  \n  \n: hall-2+8+1\n  0x8b 0xff 0xff 0xff 0x7f 0x7f 0x7f 0x0 0x36 0x27 0x1 0x18 0x8b 0x16 0x2c 0x0 0xd 0x5f 0x6 0x0 0x52 0x64 0x1 0x37 0x88 0xa 0x0 0x7f 0x7f 0x7f 0xff 0xff 0xff\n  \n  \n: hall-2+48+1\n  0x8b 0xff 0xff 0xff 0xfe 0xfe 0xfe 0x0 0x6c 0xe4 0x80 0x18 0x8b 0x68 0x34 0x0 0xb0 0xfa 0x60 0x0 0x4a 0x26 0x80 0xec 0x88 0x50 0x0 0xfe 0xfe 0xfe 0xff 0xff 0xff\n  \n  \n: hall-3+16+1\n  0x7 0xff 0x8b 0x7f 0x7f 0x3 0xac 0xd5 0x0 0x65 0x54 0x0 0x29 0x94 0x85 0xc1 0x34 0x3 0x7f 0x7f 0x7 0xff\n  \n  \n: hall-3+40+1\n  0x7 0xff 0x8b 0xfe 0xfe 0xc0 0x35 0xab 0x0 0xa6 0x2a 0x0 0x94 0x29 0x85 0x83 0x2c 0xc0 0xfe 0xfe 0x7 0xff\n  \n  \n: hall-4+16+1\n  0x7 0xff 0x8b 0x3f 0xf 0x63 0x29 0x84 0xb1 0x14 0x9 0x60 0x5 0xa8 0x85 0x84 0x29 0x63 0xf 0x3f 0x7 0xff\n  \n: hall-4+24+1\n  0xb 0xff 0x88 0x3f 0xf 0x93 0x8 0x90 0x23 0x8f 0x3f 0xb 0xff\n  \n: hall-4+32+1\n  0xb 0xff 0x88 0xfc 0xf1 0xc8 0x9 0x10 0xc5 0xf0 0xfc 0xb 0xff\n  \n: hall-4+40+1\n  0x7 0xff 0x8b 0xfc 0xf0 0xc6 0x94 0x21 0xd 0xa8 0x10 0x86 0x20 0x95 0x85 0x21 0x94 0xc6 0xf0 0xfc 0x7 0xff\n  \n  \n: hall-5+24+1\n  0xb 0xff 0x88 0x3f 0xbf 0x3 0x94 0x20 0x3 0xbf 0x3f 0xb 0xff\n  \n: hall-5+32+1\n  0xb 0xff 0x88 0xfc 0xfd 0xc0 0x9 0x24 0xc0 0xfd 0xfc 0xb 0xff\n  \n  \n: wall-1+8+1\n  0x8b 0xff 0xff 0x0 0x6 0x1f 0x3f 0x2e 0x0 0x83 0x8f 0x9f 0x8b 0x87 0x0 0x18 0x3c 0x7e 0xc 0x0 0xbf 0x9f 0x8f 0x83 0x88 0x0 0x32 0x7f 0x1e 0x4 0x0 0xff 0xff\n  \n: wall-1+16+1\n  0x8b 0xff 0xff 0x0 0x6 0x1f 0x3f 0x7c 0x0 0x87 0xcf 0xdf 0x8b 0x1f 0x0 0x3c 0x7e 0x7e 0x3c 0x0 0x3f 0x9f 0x9f 0xe 0x88 0x0 0x7c 0x3e 0x1e 0x4 0x0 0xff 0xff\n  \n: wall-1+24+1\n  0x8b 0xff 0xff 0x0 0x6 0x1e 0x3f 0x3e 0x0 0xc 0x9e 0xbe 0x8b 0x1c 0x0 0x79 0xfb 0x7b 0x31 0x0 0x1f 0xbf 0x1f 0x7 0x88 0x0 0xfc 0x7e 0x3e 0xe 0x0 0xff 0xff\n  \n: wall-1+32+1\n  0x8b 0xff 0xff 0x0 0x20 0x78 0x7c 0x3e 0x0 0x78 0xfd 0x7d 0x8b 0x7c 0x0 0x8c 0xce 0xdf 0xce 0x0 0x1c 0xbc 0xb9 0x20 0x88 0x0 0x7f 0xfe 0x7c 0x70 0x0 0xff 0xff\n  \n: wall-1+40+1\n  0x8b 0xff 0xff 0x0 0x60 0xf8 0xfc 0x7c 0x0 0xe0 0xf1 0xf3 0x8b 0xd8 0x0 0x38 0x7e 0x7c 0x38 0x0 0xcc 0xf9 0xf0 0x60 0x88 0x0 0x3e 0x7c 0x7c 0x30 0x0 0xff 0xff\n  \n: wall-1+48+1\n  0x8b 0xff 0xff 0x0 0x40 0xf0 0xfc 0x3e 0x0 0xc1 0xf1 0xf9 0x8b 0xf1 0x0 0x38 0x7e 0x7c 0x38 0x0 0xc5 0xf9 0xf9 0x71 0x88 0x0 0x4e 0xfc 0xf8 0x60 0x0 0xff 0xff\n  \n\n: wall-1-2+0+1\n  0x4 0xff 0x8b 0xfe 0xfe 0x0 0x6 0xce 0x1 0x0 0xc6 0xcf 0x0 0x1c 0x8b 0x8e 0x82 0x0 0xee 0x26 0x1 0x5c 0x45 0x0 0xfe 0xfe 0x4 0xff\n  \n  \n: wall-1-2+56+1\n  0x4 0xff 0x8b 0x7f 0x7f 0x0 0x60 0x73 0x80 0x0 0x63 0xf3 0x0 0x38 0x8b 0x71 0x41 0x0 0x77 0x64 0x80 0x3a 0xa2 0x0 0x7f 0x7f 0x4 0xff\n  \n\n: wall-1-3+0+1\n  0x6 0xff 0x8b 0xfe 0xfe 0xfe 0x0 0x55 0xea 0x0 0xa2 0x55 0x0 0x55 0x87 0x8a 0x55 0xae 0x0 0xfe 0xfe 0xfe 0x6 0xff\n  \n  \n: wall-1-3+56+1\n  0x6 0xff 0x8b 0x7f 0x7f 0x7f 0x0 0xaa 0x57 0x0 0x45 0xaa 0x0 0xaa 0x87 0x51 0xaa 0x75 0x0 0x7f 0x7f 0x7f 0x6 0xff\n  \n\n: wall-1-4+0+1\n  0x7 0xff 0x4 0xfe 0x88 0x0 0x55 0xa2 0x55 0xaa 0x15 0xaa 0x1 0x4 0xfe 0x7 0xff\n  \n  \n: wall-1-4+56+1\n  0x7 0xff 0x4 0x7f 0x88 0x0 0xaa 0x45 0xaa 0x55 0xa8 0x55 0x80 0x4 0x7f 0x7 0xff\n  \n\n: wall-1-5+0+1\n  0xb 0xff 0x2 0xff 0x84 0x0 0xaa 0x55 0x0 0xb 0xff 0x2 0xff\n  \n\n: wall-1-6+0+1\n  0xb 0xff 0x3 0xff 0x82 0x0 0x0 0xb 0xff 0x3 0xff\n  \n  \n: wall-2-3+8+1\n  0x83 0xff 0xff 0xff 0x6 0x7f 0x8b 0x0 0x56 0x2a 0x0 0x32 0x49 0x0 0x55 0xa 0x60 0x16 0x81 0x0 0x6 0x7f 0x83 0xff 0xff 0xff\n  \n  \n: wall-2-3+48+1\n  0x83 0xff 0xff 0xff 0x6 0xfe 0x8b 0x0 0x6a 0x54 0x0 0x4c 0x92 0x0 0xaa 0x50 0x6 0x68 0x81 0x0 0x6 0xfe 0x83 0xff 0xff 0xff\n  \n  \n: wall-2-4+8+1\n  0x83 0xff 0xff 0xff 0x7 0x7f 0x8a 0x7e 0x0 0x54 0x2a 0x55 0x2a 0x55 0x2a 0x0 0x7e 0x7 0x7f 0x83 0xff 0xff 0xff\n  \n  \n: wall-2-4+48+1\n  0x83 0xff 0xff 0xff 0x7 0xfe 0x8a 0x7e 0x0 0x2a 0x54 0xaa 0x54 0xaa 0x50 0x0 0x7e 0x7 0xfe 0x83 0xff 0xff 0xff\n  \n  \n: wall-2-5+8+1\n  0x83 0xff 0xff 0xff 0x7 0x7f 0x8a 0x7e 0x7e 0x7e 0x0 0x55 0x2a 0x0 0x7e 0x7e 0x7e 0x7 0x7f 0x83 0xff 0xff 0xff\n  \n  \n: wall-2-5+48+1\n  0x83 0xff 0xff 0xff 0x7 0xfe 0x8a 0x7e 0x7e 0x7e 0x0 0xaa 0x54 0x0 0x7e 0x7e 0x7e 0x7 0xfe 0x83 0xff 0xff 0xff\n  \n  \n: wall-2-6+8+1\n  0x83 0xff 0xff 0xff 0x7 0x7f 0x8b 0x7e 0x7e 0x7e 0x7f 0x0 0x0 0x7f 0x7f 0x7e 0x7e 0x7e 0x6 0x7f 0x83 0xff 0xff 0xff\n  \n  \n: wall-2-6+48+1\n  0x83 0xff 0xff 0xff 0x7 0xfe 0x8b 0x7e 0x7e 0x7e 0xfe 0x0 0x0 0xfe 0xfe 0x7e 0x7e 0x7e 0x6 0xfe 0x83 0xff 0xff 0xff\n  \n  \n: wall-2+16+1\n  0x6 0xff 0x8b 0x0 0x8 0x3d 0x0 0x18 0x79 0xfb 0x0 0x79 0x3c 0xc 0x87 0x0 0xf3 0x60 0x0 0x39 0x8c 0x0 0x6 0xff\n  \n: wall-2+24+1\n  0x6 0xff 0x8b 0x0 0xf9 0xf3 0x0 0x77 0xf7 0xf3 0x0 0xf9 0xfb 0x3b 0x87 0x0 0xde 0xc3 0x0 0xe7 0x70 0x0 0x6 0xff\n  \n: wall-2+32+1\n  0x6 0xff 0x8b 0x0 0xcc 0xef 0x0 0x87 0xf7 0xf6 0x0 0xef 0xef 0x8c 0x87 0x0 0x79 0x61 0x0 0xdf 0xce 0x0 0x6 0xff\n  \n: wall-2+40+1\n  0x6 0xff 0x8b 0x0 0x30 0x9c 0x0 0xc8 0x9e 0x1f 0x0 0x9e 0x3c 0x20 0x87 0x0 0xeb 0x8c 0x0 0x9e 0x38 0x0 0x6 0xff\n  \n  \n: wall-3+16+1\n  0x7 0xff 0x8b 0x3f 0xf 0x60 0x22 0x8d 0xb0 0x15 0xa 0x60 0xa 0xa1 0x85 0x82 0x25 0x60 0xf 0x3f 0x7 0xff\n  \n: wall-3+24+1\n  0x9 0xff 0x8b 0x0 0x2a 0x54 0x0 0x1d 0xaa 0x0 0xa2 0x9 0x54 0x3a 0x81 0x0 0x9 0xff\n  \n: wall-3+32+1\n  0x9 0xff 0x8b 0x0 0xa2 0x55 0x0 0x51 0xaa 0x0 0x95 0x28 0x44 0xaa 0x81 0x0 0x9 0xff\n  \n: wall-3+40+1\n  0x7 0xff 0x8b 0xfc 0xf0 0x6 0xa4 0x71 0xd 0x48 0xe0 0x6 0x40 0x95 0x85 0x41 0xa4 0x6 0xf0 0xfc 0x7 0xff\n  \n  \n: wall-3-3+16+1\n  0x7 0xff 0x8b 0x7f 0x7f 0x0 0xa2 0xdd 0x0 0x65 0x5a 0x0 0x2a 0x91 0x85 0xc2 0x35 0x0 0x7f 0x7f 0x7 0xff\n  \n  \n: wall-3-3+40+1\n  0x7 0xff 0x8b 0xfe 0xfe 0x0 0xa5 0x7b 0x0 0x46 0xea 0x0 0x44 0x89 0x85 0x43 0xac 0x0 0xfe 0xfe 0x7 0xff\n  \n  \n: wall-3-4+16+1\n  0x7 0xff 0x8b 0x7f 0x7f 0x78 0x7a 0x1 0x28 0x51 0x2a 0x50 0xa 0x51 0x85 0x2 0x79 0x78 0x7f 0x7f 0x7 0xff\n  \n  \n: wall-3-4+40+1\n  0x7 0xff 0x8b 0xfe 0xfe 0x1e 0x9e 0x40 0xa 0x50 0xca 0x14 0x4a 0x94 0x85 0x40 0x9e 0x1e 0xfe 0xfe 0x7 0xff\n  \n  \n: wall-3-5+16+1\n  0x7 0xff 0x8b 0x7f 0x7f 0x78 0x7a 0x79 0x78 0x1 0x52 0x28 0x2 0x79 0x85 0x7a 0x79 0x78 0x7f 0x7f 0x7 0xff\n  \n  \n: wall-3-5+40+1\n  0x7 0xff 0x8b 0xfe 0xfe 0x1e 0x9e 0x5e 0x1e 0x40 0xca 0x14 0x40 0x9e 0x85 0x5e 0x9e 0x1e 0xfe 0xfe 0x7 0xff\n  \n  \n: wall-3-6+16+1\n  0x7 0xff 0x8b 0x7f 0x7f 0x78 0x7a 0x79 0x78 0x79 0x2 0x0 0x7a 0x79 0x85 0x7a 0x79 0x78 0x7f 0x7f 0x7 0xff\n  \n  \n: wall-3-6+40+1\n  0x7 0xff 0x8b 0xfe 0xfe 0x1e 0x9e 0x5e 0x1e 0x5e 0xc0 0x0 0x5e 0x9e 0x85 0x5e 0x9e 0x1e 0xfe 0xfe 0x7 0xff\n  \n  \n: wall-4+24+1\n  0xb 0xff 0x88 0x0 0x55 0x2a 0x55 0xaa 0x45 0xaa 0x0 0xb 0xff\n  \n: wall-4+32+1\n  0xb 0xff 0x88 0x0 0x54 0x8a 0x55 0xaa 0x54 0xaa 0x0 0xb 0xff\n  \n  \n  \n: wall-4-5+16+1\n  0x7 0xff 0x8b 0x3f 0xf 0x63 0x29 0x85 0xb1 0x14 0xd 0x60 0x8 0xa9 0x85 0x81 0x29 0x63 0xf 0x3f 0x7 0xff\n  \n: wall-4-5+24+1\n  0xb 0xff 0x88 0x80 0x95 0x2a 0x15 0xaa 0x5 0xaa 0x80 0xb 0xff\n  \n: wall-4-5+32+1\n  0xb 0xff 0x88 0x1 0x55 0x88 0x55 0xa8 0x54 0xa9 0x1 0xb 0xff\n  \n: wall-4-5+40+1\n  0x7 0xff 0x8b 0xfc 0xf0 0xc6 0x94 0xa1 0x8d 0x28 0x30 0x86 0x10 0x95 0x85 0x81 0x94 0xc6 0xf0 0xfc 0x7 0xff\n  \n  \n: wall-4-6+16+1\n  0x7 0xff 0x8b 0x3f 0xf 0x63 0x29 0x85 0xb1 0x15 0xc 0x60 0x9 0xa9 0x85 0x81 0x29 0x63 0xf 0x3f 0x7 0xff\n  \n: wall-4-6+24+1\n  0xb 0xff 0x88 0x80 0x95 0xaa 0x15 0x2a 0x85 0xaa 0x80 0xb 0xff\n  \n: wall-4-6+32+1\n  0xb 0xff 0x88 0x1 0x55 0x89 0x54 0xa8 0x55 0xa9 0x1 0xb 0xff\n  \n: wall-4-6+40+1\n  0x7 0xff 0x8b 0xfc 0xf0 0xc6 0x94 0xa1 0x8d 0xa8 0x30 0x6 0x90 0x95 0x85 0x81 0x94 0xc6 0xf0 0xfc 0x7 0xff\n  \n  \n: wall-5+24+1\n  0xb 0xff 0x88 0x3f 0x4f 0x50 0x85 0x52 0x20 0x4f 0x3f 0xb 0xff\n  \n: wall-5+32+1\n  0xb 0xff 0x88 0xfc 0xf2 0xa 0x51 0xa2 0x4 0xf2 0xfc 0xb 0xff\n  \n  \n: wall-5-4+24+1\n  0xb 0xff 0x88 0x3f 0xf 0x90 0x5 0x92 0x20 0x8f 0x3f 0xb 0xff\n  \n: wall-5-4+32+1\n  0xb 0xff 0x88 0xfc 0xf1 0x8 0x51 0xa0 0x5 0xf0 0xfc 0xb 0xff\n  \n  \n: wall-5-5+24+1\n  0xb 0xff 0x88 0x3f 0xbf 0x0 0x95 0x22 0x0 0xbf 0x3f 0xb 0xff\n  \n: wall-5-5+32+1\n  0xb 0xff 0x88 0xfc 0xfd 0x0 0x51 0xa4 0x0 0xfd 0xfc 0xb 0xff\n  \n  \n: wall-5-6+24+1\n  0xb 0xff 0x88 0x3f 0xbf 0x30 0x85 0x2 0x30 0xbf 0x3f 0xb 0xff\n  \n: wall-5-6+32+1\n  0xb 0xff 0x88 0xfc 0xfd 0xc 0x41 0xa0 0xc 0xfd 0xfc 0xb 0xff\n  \n\n#####################\n# Level definition stored here\n# 0 = nothing\n# 1 = wall\n# 7 = exit\n\n: map\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n  0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01\n#####################\n# Game state\n\n: player\n  0 0 # X, Y\n: player-orientation\n  0 # orientation\n: level\n  0\n#####################\n# Nodes and leafs - the binary tree that does the decision making\n# This needs to be below the 3D image data in order to be able to reference the\n# labels in macros.\n\n# Convenience macros and constants\n\n:const numc18nodes 14\n:const numc27nodes 6\n:const numc36nodes 12\n:const numc45nodes 20\n#      --------------- +\n#      104 nodes\n\n:const numc18leafs 14\n:const numc27leafs 7\n:const numc36leafs 12\n:const numc45leafs 13\n#      --------------- +\n#      92 leafs\n\n:macro coord X Y {\n  :byte { ( ( X + 1 ) << 4 ) | Y }\n}\n\n:macro c1node X { :byte { X } }\n:macro c2node X { :byte { numc18nodes + X } }\n:macro c3node X { :byte { numc18nodes + numc27nodes + X } }\n:macro c4node X { :byte { numc18nodes + numc27nodes + numc36nodes + X } }\n\n:macro c1leaf X { :byte { 0x80 + X } }\n:macro c2leaf X { :byte { 0x80 + numc18leafs + X } }\n:macro c3leaf X { :byte { 0x80 + numc18leafs + numc27leafs + X } }\n:macro c4leaf X { :byte { 0x80 + numc18leafs + numc27leafs + numc36leafs + X } }\n:macro c5leaf X { :byte { 0x80 + numc18leafs + numc27leafs + numc36leafs + numc45leafs + X } }\n:macro c6leaf X { :byte { 0x80 + numc18leafs + numc27leafs + numc36leafs + numc45leafs + numc45leafs + X } }\n:macro c7leaf X { :byte { 0x80 + numc18leafs + numc27leafs + numc36leafs + numc36leafs + numc45leafs + numc45leafs + X } }\n:macro c8leaf X { :byte { 0x80 + numc18leafs + ( 2 * numc27leafs ) + numc36leafs + numc36leafs + numc45leafs + numc45leafs + X } }\n\n\n# Nodes represent decisions: given this point relative to the player, if there\n# is a wall there or not, go to this node or leaf. The most significant bit of\n# the target entry indicates if its a node (0) or a leaf (1). This\n# implementation detail is hidden through the macros.\n: nodes\n\n: nodes-column-one # and eight\n#        X Y  no wall    wall\n  coord -1 0  c1node 3   c1node 1   # node 0\n  coord  0 1  c1node 2   c1leaf 3   # node 1\n  coord -1 1  c1node 9   c1leaf 0   # node 2\n  coord  0 1  c1leaf 1   c1node 4   # node 3\n  coord -1 1  c1node 5   c1leaf 4   # node 4\n  coord -1 2  c1node 6   c1leaf 5   # node 5\n  coord -1 3  c1node 7   c1leaf 6   # node 6\n  coord -1 4  c1node 8   c1leaf 7   # node 7\n  coord -1 5  c1leaf 9   c1leaf 8   # node 8\n  coord  0 2  c1leaf 2   c1node 10  # node 9\n  coord -1 2  c1node 11  c1leaf 2   # node 10\n  coord -1 3  c1node 12  c1leaf 10  # node 11\n  coord -1 4  c1node 13  c1leaf 11  # node 12\n  coord -1 5  c1leaf 13  c1leaf 12  # node 13\n\n: nodes-column-two # and seven\n#        X Y  no wall    wall\n  coord  0 1  c2node 1   c2leaf 2   # node 0\n  coord -1 1  c2node 2   c2leaf 0   # node 1\n  coord -1 2  c2node 3   c2leaf 1   # node 2\n  coord -1 3  c2node 4   c2leaf 3   # node 3\n  coord -1 4  c2node 5   c2leaf 4   # node 4\n  coord -1 5  c2leaf 6   c2leaf 5   # node 5\n\n: nodes-column-three # and six\n#        X Y  no wall    wall\n  coord  0 1  c3node 1   c3leaf 3   # node 0\n  coord  0 2  c3node 2   c3leaf 4   # node 1\n  coord -1 2  c3node 3   c3node 4   # node 2\n  coord  0 3  c3leaf 1   c3node 7   # node 3\n  coord  0 3  c3node 5   c3leaf 5   # node 4\n  coord -1 3  c3node 6   c3leaf 0   # node 5\n  coord  0 4  c3leaf 2   c3node 10  # node 6\n  coord -1 3  c3node 8   c3leaf 6   # node 7\n  coord -1 4  c3node 9   c3leaf 7   # node 8\n  coord -1 5  c3leaf 9   c3leaf 8   # node 9\n  coord -1 4  c3node 11  c3leaf 2   # node 10\n  coord -1 5  c3leaf 11  c3leaf 10  # node 11\n\n: nodes-column-four # and five\n#        X Y  no wall    wall\n  coord  0 1  c4node 1   c4leaf 3   # node 0\n  coord  0 2  c4node 2   c4leaf 4   # node 1\n  coord -1 2  c4node 3   c4node 8   # node 2\n  coord  0 3  c4node 4   c4leaf 5   # node 3\n  coord  0 4  c4node 5   c4leaf 6   # node 4\n  coord  0 5  c4node 6   c4node 7   # node 5\n  coord -1 4  c4leaf 1   c4leaf 0   # node 6\n  coord -1 4  c4node 18  c4leaf 9   # node 7\n  coord  0 3  c4node 9   c4leaf 5   # node 8\n  coord -1 3  c4node 10  c4node 12  # node 9\n  coord  0 4  c4node 11  c4node 16  # node 10\n  coord  0 5  c4node 19  c4leaf 10  # node 11\n  coord  0 4  c4node 13  c4leaf 6   # node 12\n  coord -1 4  c4node 14  c4node 15  # node 13\n  coord  0 5  c4leaf 1   c4node 18  # node 14\n  coord  0 5  c4leaf 0   c4leaf 9   # node 15\n  coord -1 4  c4node 17  c4leaf 6   # node 16\n  coord -1 5  c4leaf 8   c4leaf 7   # node 17\n  coord -1 5  c4leaf 12  c4leaf 11  # node 18\n  coord -1 5  c4leaf 0   c4leaf 2   # node 19\n\n# Leafs represent images to be rendered. A path of nodes should always lead to\n# a leaf. The leafs themselves are pointers to the right images.\n: leafs\n\n  # Column 1\n  pointer hall-0+0+1      # leaf 0\n  pointer hall-1+0+1      # leaf 1\n  pointer hall-0+0+1      # leaf 2\n  pointer hall-0+0+1      # leaf 3\n  pointer hall-1+0+1      # leaf 4\n  pointer wall-1-2+0+1    # leaf 5\n  pointer wall-1-3+0+1    # leaf 6\n  pointer wall-1-4+0+1    # leaf 7\n  pointer wall-1-5+0+1    # leaf 8\n  pointer wall-1-6+0+1    # leaf 9\n  pointer hall-0+0+1      # leaf 10\n  pointer hall-0+0+1      # leaf 11\n  pointer hall-0+0+1      # leaf 12\n  pointer hall-0+0+1      # leaf 13\n\n  # Column 2\n  pointer hall-0+8+1      # leaf 0\n  pointer hall-2+8+1      # leaf 1\n  pointer wall-1+8+1      # leaf 2\n  pointer wall-2-3+8+1    # leaf 3\n  pointer wall-2-4+8+1    # leaf 4\n  pointer wall-2-5+8+1    # leaf 5\n  pointer wall-2-6+8+1    # leaf 6\n\n  # Column 3\n  pointer hall-0+16+1     # leaf 0\n  pointer hall-3+16+1     # leaf 1\n  pointer hall-4+16+1     # leaf 2\n  pointer wall-1+16+1     # leaf 3\n  pointer wall-2+16+1     # leaf 4\n  pointer wall-3+16+1     # leaf 5\n  pointer wall-3-3+16+1   # leaf 6\n  pointer wall-3-4+16+1   # leaf 7\n  pointer wall-3-5+16+1   # leaf 8\n  pointer wall-3-6+16+1   # leaf 9\n  pointer wall-4-5+16+1   # leaf 10\n  pointer wall-4-6+16+1   # leaf 11\n\n  # Column 4\n  pointer hall-0+24+1     # leaf 0\n  pointer hall-5+24+1     # leaf 1\n  pointer hall-4+24+1     # leaf 2\n  pointer wall-1+24+1     # leaf 3\n  pointer wall-2+24+1     # leaf 4\n  pointer wall-3+24+1     # leaf 5\n  pointer wall-4+24+1     # leaf 6\n  pointer wall-4-5+24+1   # leaf 7\n  pointer wall-4-6+24+1   # leaf 8\n  pointer wall-5+24+1     # leaf 9\n  pointer wall-5-4+24+1   # leaf 10\n  pointer wall-5-5+24+1   # leaf 11\n  pointer wall-5-6+24+1   # leaf 12\n\n  # Column 8\n  pointer hall-0+56+1     # leaf 0\n  pointer hall-1+56+1     # leaf 1\n  pointer hall-0+56+1     # leaf 2\n  pointer hall-0+56+1     # leaf 3\n  pointer hall-1+56+1     # leaf 4\n  pointer wall-1-2+56+1   # leaf 5\n  pointer wall-1-3+56+1   # leaf 6\n  pointer wall-1-4+56+1   # leaf 7\n  pointer wall-1-5+0+1    # leaf 8\n  pointer wall-1-6+0+1    # leaf 9\n  pointer hall-0+56+1     # leaf 10\n  pointer hall-0+56+1     # leaf 11\n  pointer hall-0+56+1     # leaf 12\n  pointer hall-0+56+1     # leaf 13\n\n  # Column 7\n  pointer hall-0+48+1     # leaf 0\n  pointer hall-2+48+1     # leaf 1\n  pointer wall-1+48+1     # leaf 2\n  pointer wall-2-3+48+1   # leaf 3\n  pointer wall-2-4+48+1   # leaf 4\n  pointer wall-2-5+48+1   # leaf 5\n  pointer wall-2-6+48+1   # leaf 6\n\n  # Column 6\n  pointer hall-0+40+1     # leaf 0\n  pointer hall-3+40+1     # leaf 1\n  pointer hall-4+40+1     # leaf 2\n  pointer wall-1+40+1     # leaf 3\n  pointer wall-2+40+1     # leaf 4\n  pointer wall-3+40+1     # leaf 5\n  pointer wall-3-3+40+1   # leaf 6\n  pointer wall-3-4+40+1   # leaf 7\n  pointer wall-3-5+40+1   # leaf 8\n  pointer wall-3-6+40+1   # leaf 9\n  pointer wall-4-5+40+1   # leaf 10\n  pointer wall-4-6+40+1   # leaf 11\n\n  # Column 5\n  pointer hall-0+32+1     # leaf 0\n  pointer hall-5+32+1     # leaf 1\n  pointer hall-4+32+1     # leaf 2\n  pointer wall-1+32+1     # leaf 3\n  pointer wall-2+32+1     # leaf 4\n  pointer wall-3+32+1     # leaf 5\n  pointer wall-4+32+1     # leaf 6\n  pointer wall-4-5+32+1   # leaf 7\n  pointer wall-4-6+32+1   # leaf 8\n  pointer wall-5+32+1     # leaf 9\n  pointer wall-5-4+32+1   # leaf 10\n  pointer wall-5-5+32+1   # leaf 11\n  pointer wall-5-6+32+1   # leaf 12\n# That's all folks!\n","options":{"tickrate":30,"fillColor":"#FFCC00","fillColor2":"#FF6600","blendColor":"#662200","backgroundColor":"#996600","buzzColor":"#FFAA00","quietColor":"#000000","shiftQuirks":false,"loadStoreQuirks":false,"vfOrderQuirks":false,"clipQuirks":true,"jumpQuirks":false,"logicQuirks":true,"vBlankQuirks":true,"screenRotation":0,"maxSize":3216,"touchInputMode":"gamepad","fontStyle":"vip","displayScale":"6"},"rom":[0,224,173,37,240,101,112,1,173,37,240,85,240,41,96,30,97,10,208,21,36,246,0,224,35,156,109,0,110,0,36,88,77,1,18,0,78,1,18,22,18,30,109,0,110,0,163,50,241,85,162,58,98,160,128,33,241,85,0,0,253,30,240,101,111,127,140,0,140,242,111,128,139,0,139,242,75,0,18,138,141,196,125,1,128,192,112,255,128,14,128,14,178,94,240,101,18,178,241,101,18,178,242,101,18,178,243,101,18,178,244,101,18,178,245,101,18,178,246,101,18,178,247,101,18,178,248,101,18,178,249,101,18,178,250,101,18,178,125,2,240,101,129,0,96,11,128,197,128,14,143,16,178,154,138,240,137,240,136,240,135,240,134,240,133,240,132,240,131,240,130,240,129,240,128,240,18,178,163,20,254,30,142,196,143,0,128,192,140,240,112,255,139,0,128,14,128,180,128,14,178,202,128,192,240,85,19,10,128,192,241,85,19,10,128,192,242,85,19,10,128,192,243,85,19,10,128,192,244,85,19,10,128,192,245,85,19,10,128,192,246,85,19,10,128,192,247,85,19,10,128,192,248,85,19,10,128,192,249,85,19,10,128,192,250,85,78,30,0,238,163,50,241,101,18,50,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,173,34,242,101,66,0,19,84,66,1,19,76,66,2,19,92,128,69,113,1,129,53,19,98,128,68,113,255,129,52,19,98,112,255,128,52,129,69,19,98,112,1,128,53,129,68,172,146,240,30,129,30,129,30,129,30,129,30,241,30,240,101,0,238,172,146,250,30,128,176,128,14,128,14,128,14,128,14,240,30,240,101,0,238,172,146,250,30,129,176,129,30,129,30,129,30,129,30,241,30,240,85,0,238,106,0,107,0,173,134,36,26,34,42,99,24,36,10,106,92,107,2,173,134,36,26,34,42,99,32,36,10,106,0,107,0,173,98,36,26,34,42,99,16,36,10,106,92,107,2,173,98,36,26,34,42,99,40,36,10,106,0,107,0,173,80,36,26,34,42,99,8,36,10,106,92,107,2,173,80,36,26,34,42,99,48,36,10,106,0,107,0,173,38,36,26,34,42,99,0,36,10,106,92,107,2,173,38,36,26,34,42,99,56,163,20,98,15,97,1,211,31,242,30,97,16,211,31,0,238,242,101,133,16,134,32,131,0,132,0,97,15,132,18,131,54,131,54,131,54,131,54,67,0,131,180,35,52,129,80,64,1,129,96,130,16,130,46,79,1,20,78,173,38,241,30,241,30,241,30,20,26,173,194,242,30,250,30,241,101,0,238,173,34,242,101,99,7,227,161,20,160,99,9,227,161,20,164,99,5,100,8,66,0,20,130,66,1,20,140,66,2,20,150,227,161,20,186,228,161,20,178,0,238,227,161,20,194,228,161,20,202,0,238,227,161,20,178,228,161,20,186,0,238,227,161,20,202,228,161,20,194,0,238,114,255,20,166,114,1,96,3,128,34,173,36,240,85,110,1,20,232,98,15,112,1,128,34,20,208,98,15,112,255,128,34,20,208,98,7,113,255,129,34,20,208,98,7,113,1,129,34,132,0,133,16,35,98,64,1,20,232,64,7,109,1,128,64,129,80,173,34,241,85,110,1,106,0,234,161,20,234,122,1,58,16,20,234,0,238,172,146,97,0,96,1,240,85,113,1,111,128,143,23,79,0,20,252,96,7,38,2,138,0,138,174,122,1,96,3,38,2,139,0,139,190,123,1,96,4,38,2,130,0,128,160,129,176,173,34,242,85,109,0,108,0,96,0,35,136,111,2,143,181,63,0,21,74,123,254,35,116,48,1,21,72,96,18,35,136,124,1,123,2,111,2,143,165,63,0,21,98,122,254,35,116,48,1,21,96,96,19,35,136,124,1,122,2,111,13,143,167,63,0,21,122,122,2,35,116,48,1,21,120,96,20,35,136,124,1,122,254,111,6,143,183,63,0,21,146,123,2,35,116,48,1,21,144,96,21,35,136,124,1,123,254,60,0,21,156,96,7,35,136,0,238,125,1,96,0,240,41,128,208,128,14,112,2,97,20,208,21,128,192,38,2,132,0,106,1,107,1,98,16,35,116,131,0,128,34,64,0,21,246,52,0,21,244,124,255,96,0,51,18,21,212,123,1,35,136,123,255,51,19,21,222,122,1,35,136,122,255,51,20,21,232,122,255,35,136,122,1,51,21,21,242,123,255,35,136,123,1,21,46,116,255,122,1,58,16,22,0,106,0,123,1,21,184,98,0,131,0,131,54,130,46,114,1,51,0,22,6,193,255,129,34,143,0,143,23,63,0,22,32,128,16,0,238,22,16,139,15,195,224,244,38,7,131,224,242,243,123,139,3,192,230,247,231,230,192,3,123,243,240,136,224,195,7,118,224,224,195,15,139,255,255,255,63,15,67,96,106,11,0,166,139,54,20,64,107,105,64,4,166,180,33,10,136,104,72,67,15,63,255,255,255,7,255,139,63,15,99,40,133,176,21,12,98,11,168,133,129,40,99,15,63,7,255,11,255,136,63,79,83,136,80,35,79,63,11,255,11,255,136,252,242,202,9,18,196,242,252,11,255,7,255,139,252,240,198,20,161,13,168,48,70,208,21,133,129,20,198,240,252,7,255,139,255,255,255,252,240,194,6,86,208,0,101,139,108,40,2,214,150,2,32,101,45,132,80,136,22,18,194,240,252,255,255,255,139,240,195,7,47,100,224,193,7,79,207,222,139,192,3,103,239,231,103,3,192,222,207,15,136,7,195,224,110,7,7,195,240,139,255,255,0,0,38,111,71,0,32,115,243,139,102,0,38,111,239,34,0,225,247,115,16,136,0,238,231,34,0,0,255,255,139,255,255,0,68,230,246,226,0,4,206,207,139,102,0,100,246,247,68,0,135,239,206,8,136,0,119,231,230,68,0,255,255,139,255,255,255,127,127,127,0,54,39,1,24,139,22,44,0,13,95,6,0,82,100,1,55,136,10,0,127,127,127,255,255,255,139,255,255,255,254,254,254,0,108,228,128,24,139,104,52,0,176,250,96,0,74,38,128,236,136,80,0,254,254,254,255,255,255,7,255,139,127,127,3,172,213,0,101,84,0,41,148,133,193,52,3,127,127,7,255,7,255,139,254,254,192,53,171,0,166,42,0,148,41,133,131,44,192,254,254,7,255,7,255,139,63,15,99,41,132,177,20,9,96,5,168,133,132,41,99,15,63,7,255,11,255,136,63,15,147,8,144,35,143,63,11,255,11,255,136,252,241,200,9,16,197,240,252,11,255,7,255,139,252,240,198,148,33,13,168,16,134,32,149,133,33,148,198,240,252,7,255,11,255,136,63,191,3,148,32,3,191,63,11,255,11,255,136,252,253,192,9,36,192,253,252,11,255,139,255,255,0,6,31,63,46,0,131,143,159,139,135,0,24,60,126,12,0,191,159,143,131,136,0,50,127,30,4,0,255,255,139,255,255,0,6,31,63,124,0,135,207,223,139,31,0,60,126,126,60,0,63,159,159,14,136,0,124,62,30,4,0,255,255,139,255,255,0,6,30,63,62,0,12,158,190,139,28,0,121,251,123,49,0,31,191,31,7,136,0,252,126,62,14,0,255,255,139,255,255,0,32,120,124,62,0,120,253,125,139,124,0,140,206,223,206,0,28,188,185,32,136,0,127,254,124,112,0,255,255,139,255,255,0,96,248,252,124,0,224,241,243,139,216,0,56,126,124,56,0,204,249,240,96,136,0,62,124,124,48,0,255,255,139,255,255,0,64,240,252,62,0,193,241,249,139,241,0,56,126,124,56,0,197,249,249,113,136,0,78,252,248,96,0,255,255,4,255,139,254,254,0,6,206,1,0,198,207,0,28,139,142,130,0,238,38,1,92,69,0,254,254,4,255,4,255,139,127,127,0,96,115,128,0,99,243,0,56,139,113,65,0,119,100,128,58,162,0,127,127,4,255,6,255,139,254,254,254,0,85,234,0,162,85,0,85,135,138,85,174,0,254,254,254,6,255,6,255,139,127,127,127,0,170,87,0,69,170,0,170,135,81,170,117,0,127,127,127,6,255,7,255,4,254,136,0,85,162,85,170,21,170,1,4,254,7,255,7,255,4,127,136,0,170,69,170,85,168,85,128,4,127,7,255,11,255,2,255,132,0,170,85,0,11,255,2,255,11,255,3,255,130,0,0,11,255,3,255,131,255,255,255,6,127,139,0,86,42,0,50,73,0,85,10,96,22,129,0,6,127,131,255,255,255,131,255,255,255,6,254,139,0,106,84,0,76,146,0,170,80,6,104,129,0,6,254,131,255,255,255,131,255,255,255,7,127,138,126,0,84,42,85,42,85,42,0,126,7,127,131,255,255,255,131,255,255,255,7,254,138,126,0,42,84,170,84,170,80,0,126,7,254,131,255,255,255,131,255,255,255,7,127,138,126,126,126,0,85,42,0,126,126,126,7,127,131,255,255,255,131,255,255,255,7,254,138,126,126,126,0,170,84,0,126,126,126,7,254,131,255,255,255,131,255,255,255,7,127,139,126,126,126,127,0,0,127,127,126,126,126,6,127,131,255,255,255,131,255,255,255,7,254,139,126,126,126,254,0,0,254,254,126,126,126,6,254,131,255,255,255,6,255,139,0,8,61,0,24,121,251,0,121,60,12,135,0,243,96,0,57,140,0,6,255,6,255,139,0,249,243,0,119,247,243,0,249,251,59,135,0,222,195,0,231,112,0,6,255,6,255,139,0,204,239,0,135,247,246,0,239,239,140,135,0,121,97,0,223,206,0,6,255,6,255,139,0,48,156,0,200,158,31,0,158,60,32,135,0,235,140,0,158,56,0,6,255,7,255,139,63,15,96,34,141,176,21,10,96,10,161,133,130,37,96,15,63,7,255,9,255,139,0,42,84,0,29,170,0,162,9,84,58,129,0,9,255,9,255,139,0,162,85,0,81,170,0,149,40,68,170,129,0,9,255,7,255,139,252,240,6,164,113,13,72,224,6,64,149,133,65,164,6,240,252,7,255,7,255,139,127,127,0,162,221,0,101,90,0,42,145,133,194,53,0,127,127,7,255,7,255,139,254,254,0,165,123,0,70,234,0,68,137,133,67,172,0,254,254,7,255,7,255,139,127,127,120,122,1,40,81,42,80,10,81,133,2,121,120,127,127,7,255,7,255,139,254,254,30,158,64,10,80,202,20,74,148,133,64,158,30,254,254,7,255,7,255,139,127,127,120,122,121,120,1,82,40,2,121,133,122,121,120,127,127,7,255,7,255,139,254,254,30,158,94,30,64,202,20,64,158,133,94,158,30,254,254,7,255,7,255,139,127,127,120,122,121,120,121,2,0,122,121,133,122,121,120,127,127,7,255,7,255,139,254,254,30,158,94,30,94,192,0,94,158,133,94,158,30,254,254,7,255,11,255,136,0,85,42,85,170,69,170,0,11,255,11,255,136,0,84,138,85,170,84,170,0,11,255,7,255,139,63,15,99,41,133,177,20,13,96,8,169,133,129,41,99,15,63,7,255,11,255,136,128,149,42,21,170,5,170,128,11,255,11,255,136,1,85,136,85,168,84,169,1,11,255,7,255,139,252,240,198,148,161,141,40,48,134,16,149,133,129,148,198,240,252,7,255,7,255,139,63,15,99,41,133,177,21,12,96,9,169,133,129,41,99,15,63,7,255,11,255,136,128,149,170,21,42,133,170,128,11,255,11,255,136,1,85,137,84,168,85,169,1,11,255,7,255,139,252,240,198,148,161,141,168,48,6,144,149,133,129,148,198,240,252,7,255,11,255,136,63,79,80,133,82,32,79,63,11,255,11,255,136,252,242,10,81,162,4,242,252,11,255,11,255,136,63,15,144,5,146,32,143,63,11,255,11,255,136,252,241,8,81,160,5,240,252,11,255,11,255,136,63,191,0,149,34,0,191,63,11,255,11,255,136,252,253,0,81,164,0,253,252,11,255,11,255,136,63,191,48,133,2,48,191,63,11,255,11,255,136,252,253,12,65,160,12,253,252,11,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,3,1,17,2,131,1,9,128,17,129,4,1,5,132,2,6,133,3,7,134,4,8,135,5,137,136,18,130,10,2,11,130,3,12,138,4,13,139,5,141,140,17,15,144,1,16,142,2,17,143,3,18,145,4,19,146,5,148,147,17,21,152,18,22,153,2,23,24,19,150,27,19,25,154,3,26,149,20,151,30,3,28,155,4,29,156,5,158,157,4,31,151,5,160,159,17,33,164,18,34,165,2,35,40,19,36,166,20,37,167,21,38,39,4,162,161,4,50,170,19,41,166,3,42,44,20,43,48,21,51,171,20,45,167,4,46,47,21,162,50,21,161,170,4,49,167,5,169,168,5,173,172,5,161,163,6,34,6,236,6,34,6,34,6,236,8,194,8,250,9,42,9,76,9,89,6,34,6,34,6,34,6,34,6,67,7,46,7,252,9,100,9,152,9,198,9,244,6,100,7,112,7,156,8,29,10,36,10,132,10,212,11,0,11,44,11,88,11,158,11,228,6,122,7,226,7,178,8,62,10,60,10,154,11,132,11,180,11,250,12,42,12,68,12,94,12,120,6,203,7,13,6,203,6,203,7,13,8,222,9,18,9,59,9,76,9,89,6,203,6,203,6,203,6,203,6,170,7,79,8,161,9,126,9,175,9,221,10,12,6,148,7,134,7,204,8,128,10,108,10,190,10,234,11,22,11,66,11,110,11,206,12,20,6,135,7,239,7,191,8,95,10,84,10,172,11,145,11,193,12,7,12,55,12,81,12,107,12,133]}</script>
<script>"use strict";

function invertKeymap(k) {
	return Object.keys(k).reduce((a,b) => {
		Object.keys(k[b]).forEach(x => a[x]=+b)
		return a
	}, {})
}

function getPref(key) {
	try { return JSON.parse(localStorage.getItem(key)) }
	catch(e) { console.log(e); return null }
}
function setPref(key, value) {
	try { localStorage.setItem(key, JSON.stringify(value)) }
	catch(e) { console.log(e); }
}

var keymap = (this.STATIC_KEYMAP) || getPref('octoKeymap') || {
	0x0: { x:1 },
	0x1: { 1:1 },
	0x2: { 2:1 },
	0x3: { 3:1 },
	0x4: { q:1 },
	0x5: { w:1, ArrowUp:1 },
	0x6: { e:1, ' ':1 },
	0x7: { a:1, ArrowLeft:1 },
	0x8: { s:1, ArrowDown:1 },
	0x9: { d:1, ArrowRight:1 },
	0xA: { z:1 },
	0xB: { c:1 },
	0xC: { 4:1 },
	0xD: { r:1 },
	0xE: { f:1 },
	0xF: { v:1 },
}

var keymapInverse = invertKeymap(keymap)

var smallfonts = {
	octo: [
		0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
		0x20, 0x60, 0x20, 0x20, 0x70, // 1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
		0x90, 0x90, 0xF0, 0x10, 0x10, // 4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
		0xF0, 0x10, 0x20, 0x40, 0x40, // 7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
		0xF0, 0x90, 0xF0, 0x90, 0x90, // A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
		0xF0, 0x80, 0x80, 0x80, 0xF0, // C
		0xE0, 0x90, 0x90, 0x90, 0xE0, // D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
		0xF0, 0x80, 0xF0, 0x80, 0x80, // F
	],
	vip: [
		0xF0, 0x90, 0x90, 0x90, 0xF0,
		0x60, 0x20, 0x20, 0x20, 0x70,
		0xF0, 0x10, 0xF0, 0x80, 0xF0,
		0xF0, 0x10, 0xF0, 0x10, 0xF0,
		0xA0, 0xA0, 0xF0, 0x20, 0x20,
		0xF0, 0x80, 0xF0, 0x10, 0xF0,
		0xF0, 0x80, 0xF0, 0x90, 0xF0,
		0xF0, 0x10, 0x10, 0x10, 0x10,
		0xF0, 0x90, 0xF0, 0x90, 0xF0,
		0xF0, 0x90, 0xF0, 0x10, 0xF0,
		0xF0, 0x90, 0xF0, 0x90, 0x90,
		0xF0, 0x50, 0x70, 0x50, 0xF0,
		0xF0, 0x80, 0x80, 0x80, 0xF0,
		0xF0, 0x50, 0x50, 0x50, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0x80,
	],
	dream6800: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x40, 0x40, 0x40, 0x40, 0x40,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0x80, 0xA0, 0xA0, 0xE0, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xE0, 0xA0, 0xC0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	eti660: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x20, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0xA0, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0x80, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0x20, 0x20, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	fish: [
		0x60, 0xA0, 0xA0, 0xA0, 0xC0,
		0x40, 0xC0, 0x40, 0x40, 0xE0,
		0xC0, 0x20, 0x40, 0x80, 0xE0,
		0xC0, 0x20, 0x40, 0x20, 0xC0,
		0x20, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xC0, 0x20, 0xC0,
		0x40, 0x80, 0xC0, 0xA0, 0x40,
		0xE0, 0x20, 0x60, 0x40, 0x40,
		0x40, 0xA0, 0x40, 0xA0, 0x40,
		0x40, 0xA0, 0x60, 0x20, 0x40,
		0x40, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xC0, 0xA0, 0xC0,
		0x60, 0x80, 0x80, 0x80, 0x60,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xC0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
}
var bigfonts = {
	octo: [
		0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, // 0
		0x18, 0x78, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0xFF, // 1
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // 2
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 3
		0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, // 4
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 5
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 6
		0xFF, 0xFF, 0x03, 0x03, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x18, // 7
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 8
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 9
		0x7E, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, // A
		0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, // B
		0x3C, 0xFF, 0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC3, 0xFF, 0x3C, // C
		0xFC, 0xFE, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFE, 0xFC, // D
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // E
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0  // F
	],
	schip: [
		0x3C, 0x7E, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3C,
		0x18, 0x38, 0x58, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
		0x3E, 0x7F, 0xC3, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFF, 0xFF,
		0x3C, 0x7E, 0xC3, 0x03, 0x0E, 0x0E, 0x03, 0xC3, 0x7E, 0x3C,
		0x06, 0x0E, 0x1E, 0x36, 0x66, 0xC6, 0xFF, 0xFF, 0x06, 0x06,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFC, 0xFE, 0x03, 0xC3, 0x7E, 0x3C,
		0x3E, 0x7C, 0xE0, 0xC0, 0xFC, 0xFE, 0xC3, 0xC3, 0x7E, 0x3C,
		0xFF, 0xFF, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7E, 0x7E, 0xC3, 0xC3, 0x7E, 0x3C,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7F, 0x3F, 0x03, 0x03, 0x3E, 0x7C,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // no hex chars!
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	],
	fish: [
		0x7C, 0xC6, 0xCE, 0xDE, 0xD6, 0xF6, 0xE6, 0xC6, 0x7C, 0x00, // at most 7x9 pixels!
		0x10, 0x30, 0xF0, 0x30, 0x30, 0x30, 0x30, 0x30, 0xFC, 0x00,
		0x78, 0xCC, 0xCC, 0x0C, 0x18, 0x30, 0x60, 0xCC, 0xFC, 0x00,
		0x78, 0xCC, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x0C, 0x1E, 0x00,
		0xFC, 0xC0, 0xC0, 0xC0, 0xF8, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x38, 0x60, 0xC0, 0xC0, 0xF8, 0xCC, 0xCC, 0xCC, 0x78, 0x00,
		0xFE, 0xC6, 0xC6, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00,
		0x78, 0xCC, 0xCC, 0xEC, 0x78, 0xDC, 0xCC, 0xCC, 0x78, 0x00,
		0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x18, 0x18, 0x30, 0x70, 0x00,
		0x30, 0x78, 0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00,
		0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0xFC, 0x00,
		0x3C, 0x66, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x66, 0x3C, 0x00,
		0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00,
		0xFE, 0x62, 0x60, 0x64, 0x7C, 0x64, 0x60, 0x62, 0xFE, 0x00,
		0xFE, 0x66, 0x62, 0x64, 0x7C, 0x64, 0x60, 0x60, 0xF0, 0x00,
	],
	none: new Array(16*10).fill(0x00),
}
var fontsets = {
	octo     : { small: smallfonts.octo,      big: bigfonts.octo  },
	vip      : { small: smallfonts.vip,       big: bigfonts.none  },
	dream6800: { small: smallfonts.dream6800, big: bigfonts.none  },
	eti660   : { small: smallfonts.eti660,    big: bigfonts.none  },
	schip    : { small: smallfonts.octo,      big: bigfonts.schip },
	fish     : { small: smallfonts.fish,      big: bigfonts.fish  },
}

////////////////////////////////////
//
//   The Chip8 Interpreter:
//
////////////////////////////////////

function Emulator() {

	// persistent configuration settings
	this.tickrate           = 20;
	this.fillColor          = "#FFCC00";
	this.fillColor2         = "#FF6600";
	this.blendColor         = "#662200";
	this.backgroundColor    = "#996600";
	this.buzzColor          = "#FFAA00";
	this.quietColor         = "#000000";
	this.shiftQuirks        = false;
	this.loadStoreQuirks    = false;
	this.vfOrderQuirks      = false;
	this.clipQuirks         = false;
	this.jumpQuirks         = false;
	this.logicQuirks        = false;
	this.vBlankQuirks       = false;
	this.enableXO           = true;
	this.screenRotation     = 0;//must be 0, 90, 180, or 270
	this.maxSize            = 3584;
	this.touchInputMode     = 'none';
	this.maskFormatOverride = true;
	this.numericFormatStr   = "default";
	this.fontStyle          = 'octo';

	// interpreter state
	this.p  = [[],[]];  // pixels
	this.m  = [];       // memory (bytes)
	this.r  = [];       // return stack
	this.v  = [];       // registers
	this.pc = 0;        // program counter
	this.i  = 0;        // index register
	this.dt = 0;        // delay timer
	this.st = 0;        // sound timer
	this.hires = false; // are we in SuperChip high res mode?
	this.flags = [];    // semi-persistent hp48 flag vars
	this.pattern = [];  // audio pattern buffer
	this.plane = 1;     // graphics plane
	this.profile_data = {};

	// control/debug state
	this.keys = {};       // track keys which are pressed
	this.waiting = false; // are we waiting for a keypress?
	this.waitReg = -1;    // destination register of an awaited key
	this.halted = true;
	this.breakpoint = false;
	this.metadata = {};
	this.tickCounter = 0;
	this.linted = false;

	// external interface stubs
	this.exitVector  = function() {}                                   // fired by 'exit'
	this.importFlags = function() { return [0, 0, 0, 0, 0, 0, 0, 0]; } // load persistent flags
	this.exportFlags = function(flags) {}                              // save persistent flags
	this.buzzTrigger = function(ticks, remainingTicks) {}                              // fired when buzzer played

	this.init = function(rom) {
		// initialise memory with a new array to ensure that it is of the right size and is initiliased to 0
		this.m = this.enableXO ? new Uint8Array(0x10000) : new Uint8Array(0x1000);

		this.p = [[], []];
		if (this.enableXO)
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		else
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }

		// initialize memory
		var font = fontsets[this.fontStyle];
		for(var z = 0; z < 32*64;            z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		for(var z = 0; z < font.small.length;z++) { this.m[z] = font.small[z]; }
		for(var z = 0; z < font.big.length;  z++) { this.m[z + font.small.length] = font.big[z]; }
		for(var z = 0; z < rom.rom.length;   z++) { this.m[0x200+z] = rom.rom[z]; }
		for(var z = 0; z < 16;               z++) { this.v[z] = 0; }
		for(var z = 0; z < 16;               z++) { this.pattern[z] = 0; }

		// initialize interpreter state
		this.r = [];
		this.pc = 0x200;
		this.i  = 0;
		this.dt = 0;
		this.st = 0;
		this.hires = false;
		this.plane = 1;

		// initialize control/debug state
		this.keys = {};
		this.waiting = false;
		this.waitReg = -1;
		this.halted = false;
		this.breakpoint = false;
		this.stack_breakpoint = -1;
		this.metadata = rom;
		this.tickCounter = 0;
		this.profile_data = {};
	}

	this.writeCarry = function(dest, value, flag) {
		this.v[dest] = (value & 0xFF);
		this.v[0xF] = flag ? 1 : 0;
		if (this.vfOrderQuirks) {
			this.v[dest] = (value & 0xFF);
		}
	}

	this.math = function(x, y, op) {
		// basic arithmetic opcodes
		switch(op) {
			case 0x0: this.v[x]  = this.v[y]; break;
			case 0x1: this.v[x] |= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x2: this.v[x] &= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x3: this.v[x] ^= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x4:
				var t = this.v[x]+this.v[y];
				this.writeCarry(x, t, (t > 0xFF));
				break;
			case 0x5:
				var t = this.v[x]-this.v[y];
				this.writeCarry(x, t, (this.v[x] >= this.v[y]));
				break;
			case 0x7:
				var t = this.v[y]-this.v[x];
				this.writeCarry(x, t, (this.v[y] >= this.v[x]));
				break;
			case 0x6:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] >> 1;
				this.writeCarry(x, t, (this.v[y] & 0x1));
				break;
			case 0xE:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] << 1;
				this.writeCarry(x, t, ((this.v[y] >> 7) & 0x1));
				break;
			default:
				haltBreakpoint("unknown math opcode "+op.toString(16).toUppercase());
		}
	}

	this.misc = function(x, rest) {
		// miscellaneous opcodes
		switch(rest) {
			case 0x01:
				this.plane = (x & 0x3);
				break;
			case 0x02:
				for(var z = 0; z < 16; z++) {
					this.pattern[z] = this.m[this.i+z];
				}
				break;
			case 0x07: this.v[x] = this.dt; break;
			case 0x0A: this.waiting = true; this.waitReg = x; break;
			case 0x15: this.dt = this.v[x]; break;
			case 0x18: this.buzzTrigger(this.v[x], this.st); this.st = this.v[x]; break;
			case 0x1E: this.i = (this.i + this.v[x])&0xFFFF; break;
			case 0x29: this.i = ((this.v[x] & 0xF) * 5); break;
			case 0x30: this.i = ((this.v[x] & 0xF) * 10 + fontsets[this.fontStyle].small.length); break;
			case 0x33:
				this.m[this.i]   = Math.floor(this.v[x]/100)%10;
				this.m[this.i+1] = Math.floor(this.v[x]/10)%10;
				this.m[this.i+2] = this.v[x]%10;
				break;
			case 0x55:
				for(var z = 0; z <= x; z++) { this.m[this.i+z] = this.v[z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x65:
				for(var z = 0; z <= x; z++) { this.v[z] = this.m[this.i+z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x75:
				for(var z = 0; z <= x; z++) { this.flags[z] = this.v[z]; }
				this.exportFlags(this.flags);
				break;
			case 0x85:
				this.flags = this.importFlags();
				if (typeof this.flags == "undefined" || this.flags == null) {
					this.flags = [0, 0, 0, 0, 0, 0, 0, 0];
				}
				for(var z = 0; z <= x; z++) { this.v[z] = this.flags[z]; }
				break;
			default:
				haltBreakpoint("unknown misc opcode "+rest.toString(16).toUppercase());
		}
	}

	this.sprite = function sprite(x, y, len) {
		this.v[0xF] = 0x0;
		var rowSize = this.hires ? 128 : 64;
		var colSize = this.hires ?  64 : 32;
		var i = this.i;
		for(var layer = 0; layer < 2; layer++) {
			if ((this.plane & (layer+1)) == 0) { continue; }
			if (len == 0) {
				// draw a SuperChip 16x16 sprite
				for(var a = 0; a < 16; a++) {
					for(var b = 0; b < 16; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+(a*2)+(b > 7 ? 1:0)] >> (7-(b%8))) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += 32;
			}
			else {
				// draw a Chip8 8xN sprite
				for(var a = 0; a < len; a++) {
					for(var b = 0; b < 8; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+a] >> (7-b)) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += len;
			}
		}
	}

	this.call = function(nnn) {
		if (this.r.length >= 12) {
			haltBreakpoint("call stack overflow.");
		}
		this.r.push(this.pc);
		this.pc = nnn
	}

	this.jump0 = function(nnn) {
		if (this.jumpQuirks) { this.pc = nnn + this.v[(nnn >> 8)&0xF];  }
		else                 { this.pc = nnn + this.v[0]; }
	}

	this.machine = function(nnn) {
		if (nnn == 0x000) { this.halted = true; return; }
		haltBreakpoint("machine code is not supported.");
	}

	this.skip = function() {
		var op = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		this.pc += (op == 0xF000) ? 4 : 2;
	}

	this.opcode = function() {
		// Increment profilining data
		this.profile_data[this.pc] = (this.profile_data[this.pc] || 0) + 1;

		// decode the current opcode
		var op  = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		var o   = (this.m[this.pc  ] >> 4) & 0x00F;
		var x   = (this.m[this.pc  ]     ) & 0x00F;
		var y   = (this.m[this.pc+1] >> 4) & 0x00F;
		var n   = (this.m[this.pc+1]     ) & 0x00F;
		var nn  = (this.m[this.pc+1]     ) & 0x0FF;
		var nnn = op & 0xFFF;
		this.pc += 2;

		// execute a simple opcode
		if (op == 0x00E0) {
			// clear
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = 0;
				}
			}
			return;
		}
		if (op == 0x00EE) {
			// return
			this.pc = this.r.pop();
			return;
		}
		if ((op & 0xF0FF) == 0xE09E) {
			// if -key
			if (Object.keys(keymap[this.v[x]]||{}).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xF0FF) == 0xE0A1) {
			// if key
			if (!Object.keys(keymap[this.v[x]]||{}).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xFFF0) == 0x00C0) {
			// scroll down n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = this.p[layer].length - 1; z >= 0; z--) {
					this.p[layer][z] = (z >= rowSize * n) ? this.p[layer][z - (rowSize * n)] : 0;
				}
			}
			return;
		}
		if ((op & 0xFFF0) == 0x00D0) {
			// scroll up n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = (z < (this.p[layer].length - rowSize * n)) ? this.p[layer][z + (rowSize * n)] : 0;
				}
			}
			return;
		}
		if (op == 0x00FB) {
			// scroll right 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = rowSize-1; b >= 0; b--) {
						this.p[layer][a + b] = (b > 3) ? this.p[layer][a + b - 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FC) {
			// scroll left 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = 0; b < rowSize; b++) {
						this.p[layer][a + b] = (b < rowSize - 4) ? this.p[layer][a + b + 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FD) {
			// exit
			this.halted = true;
			this.exitVector();
			return;
		}
		if (op == 0x00FE) {
			// lores
			this.hires = false;
			this.p = [[], []];
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0x00FF) {
			// hires
			this.hires = true;
			this.p = [[], []];
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0xF000) {
			// long memory reference
			this.i = ((this.m[this.pc] << 8) | (this.m[this.pc+1])) & 0xFFFF;
			this.pc += 2;
			return;
		}

		if (o == 0x5 && n != 0) {
			if (n == 2) {
				// save range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x-z]; }}
				return;
			}
			else if (n == 3) {
				// load range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.v[x+z] = this.m[this.i+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.v[x-z] = this.m[this.i+z]; }}
				return;
			}
			else {
				haltBreakpoint("unknown opcode "+op.toString(16).toUppercase());
			}
		}
		if (o == 0x9 && n != 0) {
			haltBreakpoint("unknown opcode "+op.toString(16).toUppercase());
		}

		// dispatch complex opcodes
		switch(o) {
			case 0x0: this.machine(nnn);                            break;
			case 0x1: this.pc = nnn;                                break;
			case 0x2: this.call(nnn);                               break;
			case 0x3: if (this.v[x] == nn)        { this.skip(); }  break;
			case 0x4: if (this.v[x] != nn)        { this.skip(); }  break;
			case 0x5: if (this.v[x] == this.v[y]) { this.skip(); }  break;
			case 0x6: this.v[x] = nn;                               break;
			case 0x7: this.v[x] = (this.v[x] + nn) & 0xFF;          break;
			case 0x8: this.math(x, y, n);                           break;
			case 0x9: if (this.v[x] != this.v[y]) { this.skip(); }  break;
			case 0xA: this.i = nnn;                                 break;
			case 0xB: this.jump0(nnn);                              break;
			case 0xC: this.v[x] = (Math.random()*256)&nn;           break;
			case 0xD: this.sprite(this.v[x], this.v[y], n);         break;
			case 0xF: this.misc(x, nn);                             break;
			default: haltBreakpoint("unknown opcode "+o.toString(16).toUppercase());
		}
	}

	this.tick = function() {
		if (this.halted) { return; }
		this.tickCounter++;
		try {
			this.opcode();
		}
		catch(err) {
			console.log("halted: " + err);
			this.halted = true;
		}
	}
}
</script>
<script>"use strict";

////////////////////////////////////
//
//   Emulator Execution
//
////////////////////////////////////

//must be set > 0
var scaleFactor = 5;
//dom id for canvas element
var renderTarget = "target";

const optionFlags = [
	"tickrate",
	"fillColor",
	"fillColor2",
	"blendColor",
	"backgroundColor",
	"buzzColor",
	"quietColor",
	"shiftQuirks",
	"loadStoreQuirks",
	"vfOrderQuirks",
	"clipQuirks",
	"vBlankQuirks",
	"jumpQuirks",
	"screenRotation",
	"maxSize",
	"touchInputMode",
	"logicQuirks",
	"fontStyle",
]
function unpackOptions(emulator, options) {
	optionFlags.forEach(x => { if (x in options) emulator[x] = options[x] })
	if (options["enableXO"]) emulator.maxSize = 65024 // legacy option
}
function packOptions(emulator) {
	const r = {}
	optionFlags.forEach(x => r[x] = emulator[x])
	return r
}

function setRenderTarget(scale, canvas) {
	scaleFactor = scale;
	renderTarget = canvas;
	var c = document.getElementById(canvas);

	// Remove any existing previous delta frame so first frame is always drawn:
	c.last = undefined;

	var w  = scaleFactor * 128;
	var h  = scaleFactor *  64;

	if (emulator.screenRotation == 90 || emulator.screenRotation == 270) {
		c.width  = h;
		c.height = w;
	}
	else {
		c.width  = w;
		c.height = h;
	}
}

function setTransform(emulator, g) {
	g.setTransform(1, 0, 0, 1, 0, 0);
	var x = scaleFactor * 128;
	var y = scaleFactor *  64;
	switch(emulator.screenRotation) {
		case 90:
			g.rotate(0.5 * Math.PI);
			g.translate(0, -y);
			break;
		case 180:
			g.rotate(1.0 * Math.PI);
			g.translate(-x, -y);
			break;
		case 270:
			g.rotate(1.5 * Math.PI);
			g.translate(-x, 0);
			break;
		default:
			console.assert(emulator.screenRotation === 0, 'Screen rotation not set to 0, 90, 180, or 270. Treating as 0.')
	}
}


function arrayEqual(a, b) {
	var length = a.length;
	if (length !== b.length) { return false; }
	for (var i = 0; i < length; i++) {
		if (a[i] !== b[i]) { return false; }
	}
	return true;
}

function getColor(id) {
	switch(id) {
		case 0: return emulator.backgroundColor;
		case 1: return emulator.fillColor;
		case 2: return emulator.fillColor2;
		case 3: return emulator.blendColor;
	}
	throw "invalid color: " + id;
}

function renderDisplay(emulator) {
	var c = document.getElementById(renderTarget);

	// Canvas rendering can be expensive. Exit out early if nothing has changed.
	var colors = [emulator.backgroundColor, emulator.fillColor, emulator.fillColor2, emulator.blendColor];
	if (c.last !== undefined) {
		if (arrayEqual(c.last.p[0], emulator.p[0]) && arrayEqual(c.last.p[1], emulator.p[1])
				&& arrayEqual(c.last.colors, colors)) {
			return;
		}
		if (c.last.hires !== emulator.hires)
			c.last = undefined;  // full redraw when switching resolution
	}
	var g = c.getContext("2d");
	setTransform(emulator, g);
	var w      = emulator.hires ? 128         : 64;
	var h      = emulator.hires ? 64          : 32;
	var size   = emulator.hires ? scaleFactor : scaleFactor*2;
	var lastPixels = c.last !== undefined? c.last.p: [[], []]

	g.scale(size, size)
	var z = 0;
	for(var y = 0; y < h; ++y) {
		for(var x = 0; x < w; ++x, ++z) {
			var oldColorIdx = lastPixels[0][z] + (lastPixels[1][z] << 1);
			var colorIdx = emulator.p[0][z] + (emulator.p[1][z] << 1);
			if (oldColorIdx !== colorIdx) {
				g.fillStyle = getColor(colorIdx);
				g.fillRect(x, y, 1, 1);
			}
		}
	}
	g.scale(1, 1) //restore scale to 1,1 just in case

	c.last = {
		colors: colors,
		p: [emulator.p[0].slice(), emulator.p[1].slice()],
		hires: emulator.hires,
	};
}

////////////////////////////////////
//
//   Audio Playback
//
////////////////////////////////////

var audio;
var audioNode;
var audioSource;
var audioData;

var AudioBuffer = function(buffer, duration) {
	if (!(this instanceof AudioBuffer)) {
		return new AudioBuffer(buffer, duration);
	}

	this.pointer = 0;
	this.buffer = buffer;
	this.duration = duration;
}

AudioBuffer.prototype.write = function(buffer, index, size) {
	size = Math.max(0, Math.min(size, this.duration))
	if (!size) { return size; }

	this.duration -= size;
	var bufferSize = this.buffer.length;
	var end = index + size;

	for(var i = index; i < end; ++i) {
		buffer[i] = this.buffer[this.pointer++];
		this.pointer %= bufferSize;
	}

	return size;
}

AudioBuffer.prototype.dequeue = function(duration) {
	this.duration -= duration;
}

var FREQ = 4000;
var TIMER_FREQ = 60;
var SAMPLES = 16;
var BUFFER_SIZE = SAMPLES * 8


function audioEnable() {
	// this will only work if called directly from a user-generated input handler:
	if (audio && audio.state == 'suspended') audio.resume()
}

function audioSetup() {
	if (!audio) {
		if (typeof AudioContext !== 'undefined') {
			audio = new AudioContext();
		}
		else if (typeof webkitAudioContext !== 'undefined') {
			audio = new webkitAudioContext();
		}
	}
	audioEnable()
	if (audio && !audioNode) {
		audioNode = audio.createScriptProcessor(4096, 1, 1);
		audioNode.onaudioprocess = function(audioProcessingEvent) {
			var outputBuffer = audioProcessingEvent.outputBuffer;
			var outputData = outputBuffer.getChannelData(0);
			var samples_n = outputBuffer.length;

			var index = 0;
			while(audioData.length && index < samples_n) {
				var size = samples_n - index;
				var written = audioData[0].write(outputData, index, size);
				index += written;
				if (written < size) {
					audioData.shift();
				}
			}

			while(index < samples_n) {
				outputData[index++] = 0;
			}
			//the last one can be long sound with high value of buzzer, so always keep it
			if (audioData.length > 1) {
				var audioDataSize = 0;
				var audioBufferSize = audioNode.bufferSize;
				audioData.forEach(function(buffer) { audioDataSize += buffer.duration; })
				while(audioDataSize > audioBufferSize && audioData.length > 1) {
					audioDataSize -= audioData.shift().duration;
				}
			}
		}
		audioData = [];
		audioNode.connect(audio.destination);
		return true;
	}
	if (audio && audioNode) { return true; }
	return false;
}

function stopAudio() {
	if (!audio) { return; }
	if (audioNode) {
		audioNode.disconnect();
		audioNode = null;
	}
	audioData = [];
}

var VOLUME = 0.25;

function playPattern(soundLength, buffer, remainingTicks) {
	if (!audio) { return; }
	audioEnable()

	var samples = Math.floor(BUFFER_SIZE * audio.sampleRate / FREQ);
	var audioBuffer = new Array(samples);
	if (remainingTicks && audioData.length > 0) {
		audioData[audioData.length - 1].dequeue(Math.floor(remainingTicks * audio.sampleRate / TIMER_FREQ));
	}

	for(var i = 0; i < samples; ++i) {
		var srcIndex = Math.floor(i * FREQ / audio.sampleRate);
		var cell = srcIndex >> 3;
		var bit = srcIndex & 7;
		audioBuffer[i] = (buffer[srcIndex >> 3] & (0x80 >> bit)) ? VOLUME: 0;
	}
	audioData.push(new AudioBuffer(audioBuffer, Math.floor(soundLength * audio.sampleRate / TIMER_FREQ)));
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}
</script>
<script>/**
* Adaptive Input
**/

const ael = (element, event, listener) => element.addEventListener   (event, listener, { passive:false })
const rel = (element, event, listener) => element.removeEventListener(event, listener, { passive:false })
const pd  = event => (event.preventDefault(),event.stopPropagation())

const VIP_HEX  = '123c456d789ea0bf'.split('')
const VIP_KEYS = VIP_HEX.map(x => parseInt(x,16))

const GAMEPAD_STYLES = `
.gamepad{
  position:absolute;
  top:10%;
  left:0px;
  width:100%;
  height:90%;
  opacity:0.3;
  user-select: none;
  -webkit-user-select: none;
}
.gamepad .dpad{
  position:absolute;
  bottom: 50px;
  left:   50px;
  width:  250px;
  height: 250px;
  background: gray;
  border-radius: 50%;
  overflow:hidden;
}
.gamepad .stick{
  display:none;
  position:absolute;
  border-radius: 50%;
  width:100px;
  height:100px;
  margin-left:-50px;
  margin-top:-50px;
}
.gamepad .buttons{
  position:absolute;
  bottom: 50px;
  right:  50px;
  width:  250px;
  height: 250px;
}
.gamepad .gamebutton{
  position:absolute;
  width:  125px;
  height: 125px;
  background:gray;
  border-radius:50%;
  overflow:hidden;
  line-height: 125px;
  font-size:50px;
  font-weight:bold;
  color:darkgray;
  text-align:center;
}
.gamepad .dpad.active .stick {display:block;background:#444}
.gamepad .gamebutton.active{background:#444;}
.gamepad .gamebutton.b{left:0;bottom:0;}
.gamepad .gamebutton.a{right:0;top:0;}
`
const VIP_STYLES = `
.vip-pad {display:flex;flex-direction:column;align-items:center;z-index:2000;}
.vip-pad .keypad {display:flex;flex-direction:column;margin-top:10px;}
.vip-pad .keypad>div {display:flex;flex-direction:row;}
.vip-pad .keypad>div>div {
  -webkit-user-select: none;
  user-select: none;
  background:gray;
  width: 100px;
  height: 51px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 1px;
}
.vip-pad .keypad>div>div:active,
.vip-pad .keypad>div>div.active {background:black; border:1px solid white;margin:0px;}
`

const INPUT_MODULES = {
  /**
  * An invisible set of gesture recognizers,
  * giving directional input and an action for taps.
  **/
  swipe: {
    install: (screen,up,down,options) => {

      let vdirs      = []
      let direction  = { i:null, sx:0, sy:0, lx:0, ly:0 }
      let action1    = {}
      let taptimeout = null

      const updateStick = _ => {
        // find the relative position of the stick to its starting point
        const cx = direction.lx - direction.sx
        const cy = direction.ly - direction.sy

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }
      const tapDown= i => {
        if (Object.keys(action1).length == 0) down(options.action1)
        action1[i] = true
        if (i == direction.i) { direction = { i:null, sx:0, sy:0, lx:0, ly:0 } }
        taptimeout = null
      }
      const start = e => {
        const t = e.touches[0]
        const i = t.identifier
        // a single-touch is either directional or a tap...
        if (direction.i != null) {
          tapDown(i)
        }
        else {
          direction.i  = i
          direction.sx = t.clientX
          direction.sy = t.clientY
          direction.lx = t.clientX
          direction.ly = t.clientY
          taptimeout = setTimeout(_ => tapDown(i), 100)
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) { clearTimeout(taptimeout); taptimeout = null }
            direction.lx = t.clientX
            direction.ly = t.clientY
          }
        }
        updateStick(),pd(e)
      }
      const end = e => {
        let r1 = false
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) {
              // cancel a short tap
              clearTimeout(taptimeout); taptimeout = null
              down(options.action1)
              setTimeout(_ => up(options.action1), 50)
            }
            direction = { i:null, sx:0, sy:0, lx:0, ly:0 }
          }
          if (i in action1) {
            delete action1[i]
            r1=true
          }
        }
        if (r1 && Object.keys(action1).length == 0) up(options.action1)
        updateStick(),pd(e)
      }
      ael(screen, 'touchstart', start)
      ael(screen, 'touchmove',  move)
      ael(screen, 'touchend',   end)
      screen.uninstallSwipe = _ => {
        rel(screen, 'touchstart', start)
        rel(screen, 'touchmove',  move)
        rel(screen, 'touchend',   end)
      }
    },
    remove: (screen) => {
      screen.uninstallSwipe()
      delete screen.uninstallSwipe
    }
  },

  /**
  * A virtual gamepad overlay with two remappable action keys.
  **/
  gamepad: {
    install: (screen,up,down,options) => {
      // build the UI
      if (document.querySelector('.gamepad')) return
      const root = document.createElement('div')
      root.classList.add('gamepad')
      root.innerHTML = `
      <div class='dpad'><div class='stick'></div></div>
      <div class='buttons'><div class='gamebutton b'>B</div><div class='gamebutton a'>A</div></div>
      <style>${GAMEPAD_STYLES}</style>`
      screen.parentElement.append(root)

      let vdirs      = []
      let directions = {}
      let buttons    = {}
      const pad   = document.querySelector('.gamepad .dpad')
      const stick = document.querySelector('.gamepad .dpad .stick')
      const a     = document.querySelector('.gamepad .gamebutton.a')
      const b     = document.querySelector('.gamepad .gamebutton.b')

      const updateStick = _ => {
        // find centroid of d-pad touchpoints ({0,0} if no touchpoints)
        const touches = Object.values(directions)
        let cx = 0, cy = 0, r = pad.getBoundingClientRect(), sr = stick.getBoundingClientRect()
        touches.forEach(t => (cx+=t.x, cy+=t.y))
        cx /= touches.length,         cy /= touches.length
        cx -= (r.left + (r.width/2)), cy -= (r.top + (r.height/2))

        // position the virtual stick, clamped within dpad
        const ca = Math.atan2(cy, cx)
        const cd = Math.min(Math.sqrt(cx*cx + cy*cy), (r.width/2)-(sr.width/2))
        stick.style.left = ((Math.cos(ca)*cd)+(r.width /2)|0)+'px'
        stick.style.top  = ((Math.sin(ca)*cd)+(r.height/2)|0)+'px'

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }

      const start = e => {
        for(let z = 0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          if (t.target == a) {
            t.target.classList.add('active')
            buttons[i]=options.action1
            down(options.action1)
          }
          if (t.target == b) {
            t.target.classList.add('active')
            buttons[i]=options.action2
            down(options.action2)
          }
          if (t.target == pad) {
            t.target.classList.add('active')
            directions[i]={x:t.clientX, y:t.clientY}
          }
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in directions) directions[i]={x:t.clientX, y:t.clientY}
        }
        updateStick(),pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in buttons) {
            t.target.classList.remove('active')
            up(buttons[i])
            delete buttons[i]
          }
          if (i in directions) {
            t.target.classList.remove('active')
            delete directions[i]
          }
        }
        updateStick(),pd(e)
      }

      ael(a,   'touchstart', start)
      ael(a,   'touchend',   end  )
      ael(b,   'touchstart', start)
      ael(b,   'touchend',   end  )
      ael(pad, 'touchstart', start)
      ael(pad, 'touchmove',  move )
      ael(pad, 'touchend',   end  )
    },
    remove: (screen) => {
      document.querySelector('.gamepad').remove()
    },
  },

  /**
  * Treat the entire screen, or a centered square region, as invisible buttons,
  * mapped out in the order of the VIP hex keypad.
  **/
  seg16: {
    install: (screen,up,down,options) => {
      const tmap = {}
      const pointToKey = touch => {
        // poll this for each point, as it may vary over time,
        // and experimentally it's never right initially...
        const r = screen.getBoundingClientRect()
        if (options.mode == 'center') {
          if (r.width > r.height) { r.x += (r.width - r.height)/2; r.width = r.height }
          else                    { r.y += (r.height - r.width)/2; r.height = r.width }
        }
        const x = touch.clientX - r.x
        const y = touch.clientY - r.y
        if (x < 0 || x > r.width || y < 0 || y > r.height) return null
        const tx = Math.floor(x / (r.width /4))
        const ty = Math.floor(y / (r.height/4))
        return VIP_KEYS[tx + (4 * ty)]
      }
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (k != null) down(k)
          tmap[i]=k
        }
        pd(e)
      }
      const move = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (tmap[i] == k) continue       // same cell, nothing to do.
          if (tmap[i] != null) up(tmap[i]) // release old key, if any
          if (k != null)       down(k)     // press new key, if any
          tmap[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z=0; z<e.changedTouches.length; z++) {
          const i = e.changedTouches[z].identifier
          const k = pointToKey(e.changedTouches[z])
          if (tmap[i] != null) up(tmap[i])
          tmap[i]=null
        }
        pd(e)
      }
      ael(screen, 'touchstart', start)
      ael(screen, 'touchmove',  move )
      ael(screen, 'touchend',   end  )
      screen.uninstallSeg16 = _ => {
        rel(screen, 'touchstart', start)
        rel(screen, 'touchmove',  move )
        rel(screen, 'touchend',   end  )
      }
    },
    remove:  (screen) => {
      screen.uninstallSeg16()
      delete screen.uninstallSeg16
    },
  },

  /**
  * Provide a visible 4x4 representation of the VIP hex keypad.
  **/
  vip: {
    install: (screen,up,down,options) => {
      if (document.querySelector('.vip-pad')) return
      const root = document.createElement('div')
      root.classList.add('vip-pad')
      root.innerHTML = `<div class='keypad'>
        ${[0,1,2,3].map(r=>`<div>${[0,1,2,3].map(c=>`<div>${VIP_HEX[c+(r*4)].toUpperCase()}</div>`).join('')}</div>`).join('')}
      </div>
      <style>${VIP_STYLES}</style>`
      if (screen.parentElement == document.body) { screen.parentElement.append(root) }
      else { screen.parentElement.parentElement.append(root) }
      const buttons = []
      document.querySelectorAll('.vip-pad .keypad>div>div').forEach(x=>buttons.push(x)) // make an actual Array
      const held = {}
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          const k = VIP_KEYS[buttons.indexOf(t.target)]
          t.target.classList.add('active')
          down(k)
          held[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (held[i]) { up(held[i]); delete held[i] }
          t.target.classList.remove('active')
        }
        pd(e)
      }
      buttons.forEach(b => {
        ael(b, 'touchstart', start)
        ael(b, 'touchend',   end  )
      })
    },
    remove:  (screen) => {
      document.querySelector('.vip-pad').remove()
    },
  },
}

let adaptiveControlsInstalled = null

function injectAdaptiveControls(type, screen, keyup, keydown) {
  let options = {
    up:      5,
    down:    8,
    left:    7,
    right:   9,
    action1: 6,
    action2: 4,
    mode:    'center', // or 'fill', used by seg16
  }
  const lookup = vk => Object.keys(keymap[vk])[0]
  const install = _ => {
    rel(screen, 'touchstart', install)
    adaptiveControlsInstalled = type
    INPUT_MODULES[type].install(
      screen,
      key => keyup  ({ key:lookup(key), preventDefault:_=>_ }),
      key => keydown({ key:lookup(key), preventDefault:_=>_ }),
      options
    )
  }
  // uninstall anything that's already there:
  rel(screen, 'touchstart', install)
  if (adaptiveControlsInstalled) INPUT_MODULES[adaptiveControlsInstalled].remove(screen)

  if (type == 'none') return
  if (type == 'seg16fill') { type='seg16'; options.mode='fill' }
  // defer installing adaptive input until we actually see
  // an input event from the user:
  ael(screen, 'touchstart', install)
}
</script>
<body><canvas id='target' width=512 height=256></canvas></body>
<style>body{margin:0px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;}</style>
<script>
const emulator = new Emulator()
unpackOptions(emulator, data.options)
setRenderTarget(data.options.displayScale || 4, 'target')
emulator.init({rom:data.rom})
emulator.importFlags = _ => getPref('octoFlagRegisters')
emulator.exportFlags = f => setPref('octoFlagRegisters',f)
emulator.buzzTrigger = (ticks,rest)=> playPattern(ticks, emulator.pattern, rest)
const kd = e=>{
	if (!audio) audioSetup()
	if (!(e.key in emulator.keys)) emulator.keys[e.key]=true
	e.preventDefault()
}
const ku = e=>{
	if (e.key in emulator.keys) delete emulator.keys[e.key]
	if (!emulator.waiting) return
	const kindex = keymapInverse[e.key]
	if (kindex != undefined) {
		emulator.waiting = false
		emulator.v[emulator.waitReg] = kindex
	}
	e.preventDefault()
}
window.addEventListener('keydown',kd,false)
window.addEventListener('keyup',ku,false)
intervalHandle = setInterval(_=>{
	if (emulator.halted) return
	for(var z = 0; (z<emulator.tickrate) && (!emulator.waiting); z++) emulator.tick()
	if (emulator.dt > 0) emulator.dt--
	if (emulator.st > 0) emulator.st--
	renderDisplay(emulator)
	document.body.style.backgroundColor = emulator.st?emulator.buzzColor:emulator.quietColor
}, 1000/60)

injectAdaptiveControls(emulator.touchInputMode,document.getElementById('target'),ku,kd)
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B8K64BTSGZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-B8K64BTSGZ');
</script>
